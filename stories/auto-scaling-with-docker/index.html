<!DOCTYPE html> <html> <head> <title>Auto Scaling with Docker</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="In the article Load Balancing with Docker Swarm, we scaled a service by deploying multiple instance of the same docker image across the hosts in a Docker Swa..."> <meta name="author" content="Hanzel Jesheen"> <meta itemprop="name" content="Auto Scaling with Docker"> <meta itemprop="description" content="In the article Load Balancing with Docker Swarm, we scaled a service by deploying multiple instance of the same docker image across the hosts in a Docker Swa..."> <link rel="canonical" href="https://botleg.com/stories/auto-scaling-with-docker/"> <link rel="alternate" type="application/rss+xml" title="Botleg" href="https://botleg.com/feed" /> </head> <body> <div class="page-content"> <div class="post"> <header style="background:rgb(142, 68, 173);background-image:linear-gradient(90deg, rgb(142, 68, 173) 25%, rgb(192, 57, 43) 100%);background-image:-moz-linear-gradient(left, rgb(142, 68, 173) 25%, rgb(192, 57, 43) 100%);background-image:-webkit-linear-gradient(left, rgb(142, 68, 173) 25%, rgb(192, 57, 43) 100%);background-image:-o-linear-gradient(left, rgb(142, 68, 173) 25%, rgb(192, 57, 43) 100%);background-image:-ms-linear-gradient(left, rgb(142, 68, 173) 25%, rgb(192, 57, 43) 100%);"> <section class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <a href="/feed/index.xml"><span class="rss-icon"> <svg viewBox="0 0 24 24" width="30px" height="30px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg></span> </a> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </section> <section class="post-header"> <div class="header-content"> <h1 class="post-title">Auto Scaling with Docker</h1> <a class="icon gh" href="https://github.com/botleg/replicator" target="blank"><span>View Code</span></a> </div> </section> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Jul 13, 2016 | <a href="/categories/devops">devops</a> </p> <p>In the article <a href="/stories/load-balancing-with-docker-swarm/">Load Balancing with Docker Swarm</a>, we scaled a service by deploying multiple instance of the same docker image across the hosts in a Docker Swarm and distibuted the traffic among these instances using a load balancer. However, the scaling is manually done using <code class="highlighter-rouge">docker-compose</code> commands.</p> <p>In this article, we are going to automate the scaling procedure using <a href="https://docs.docker.com/engine/reference/api/docker_remote_api/">Docker Remote API</a>. We will be creating a <code class="highlighter-rouge">Replicator</code> docker image that listens to requests with container ID as the parameter and can create and deploy new docker images similar to the one with the given container ID.</p> <p>The docker image for Replicator is <a href="https://hub.docker.com/r/hanzel/replicator/">hanzel/replicator</a> and its code can be found <a href="https://github.com/botleg/replicator">here</a>. Also, the docker image for testing this is <a href="https://hub.docker.com/r/hanzel/node-replicate/">hanzel/node-replicate</a> and its code can be found <a href="https://github.com/botleg/node-replicate">here</a>.</p> <h2 id="docker-remote-api">Docker Remote API</h2> <p><a href="https://docs.docker.com/engine/reference/api/docker_remote_api/">Docker Remote API</a> allows us to remotely access the Docker Engine and do all the actions that we could do locally. You can see the API reference <a href="https://docs.docker.com/engine/reference/api/docker_remote_api_v1.23/">here</a>. For our purposes, we need the following endpoints:</p> <ul> <li><code class="highlighter-rouge">GET /containers/&lt;id&gt;/json</code>: To inspect the container.</li> <li><code class="highlighter-rouge">POST /containers/create</code>: To create a new container.</li> <li><code class="highlighter-rouge">POST /containers/&lt;id&gt;/start</code>: To deploy the new container.</li> </ul> <p>To send requests to the Docker Remote API, we need to verify the client using the certificate (cert.pem) and the private key (key.pem) files. To verify the client, we also need the certificate authority (ca.pem) file. When using Docker Machine, the environment variable <code class="highlighter-rouge">DOCKER_CERT_PATH</code> contains the path of the folder containing these files.</p> <p>The <code class="highlighter-rouge">Replicator</code> docker image will listen for requests which contains a container ID. This ID is used to inspect the container and create one similar to it. Then the newly created container is deployed. Now we can scale by sending a request to this Replicator image with the container ID. This can be done in two ways:</p> <ul> <li>A running container can request the Replicator with its own container ID, if it cannot handle the traffic.</li> <li>The container can send metrics to some monitoring service along with its container ID. Then the monitoring service can send the request to the Replicator with the container ID as needed.</li> </ul> <h2 id="replicator-image">Replicator Image</h2> <p>The Replicator image will be based on the <a href="https://www.alpinelinux.org/">Alpine Linux</a> and it will contain a <a href="https://nodejs.org/">Node.js</a> server along with <a href="https://www.nginx.com/">NGINX</a>. Node.js server will be used to listen for the request and communicate with Docker Remote API. NGINX is used as a reverse proxy to the Node.js server and it also handle the client verification with the certificates. The docker image for Replicator is <a href="https://hub.docker.com/r/hanzel/replicator/">hanzel/replicator</a> and its code can be found <a href="https://github.com/botleg/replicator">here</a>.</p> <p>We need the certificate and key file to access the Remote API. So, we use these same files to authenticate the clients of our Docker Image. We need to have the file <code class="highlighter-rouge">cert.pem</code>, <code class="highlighter-rouge">key.pem</code>, <code class="highlighter-rouge">ca.pem</code> in the folder <code class="highlighter-rouge">/ssl</code> in our Docker Image. We will discuss how to get the files there later when we are testing this image. We also need to set the <code class="highlighter-rouge">DOCKER_HOST</code> environment variable with IP and port to access the Remote API. The Docker Machine save this in the format <code class="highlighter-rouge">tcp://&lt;ip&gt;:&lt;port&gt;</code> inside the environment variable <code class="highlighter-rouge">DOCKER_HOST</code>. We just have to pass this value to the docker image. In the next three sections, we will build the Replicator image.</p> <h2 id="nodejs-application">Node.js Application</h2> <p>The Node.js application will contain only one javascript file <code class="highlighter-rouge">server.js</code> and uses <a href="http://koajs.com/">koa</a> as the web server and <code class="highlighter-rouge">co-request</code> to send requests to Docker Remote API. So the <code class="highlighter-rouge">package.json</code> file will look like this.</p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"replicator"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server.js"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node server.js"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"co-request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"koa"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.2.0"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>The <code class="highlighter-rouge">server.js</code> files starts with setting values to the variables.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">)(),</span>
  <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">),</span>
  <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'co-request'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'/ssl/cert.pem'</span><span class="p">),</span>
  <span class="nx">key</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'/ssl/key.pem'</span><span class="p">),</span>
  <span class="nx">ca</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'/ssl/ca.pem'</span><span class="p">),</span>
  <span class="nx">host</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DOCKER_HOST</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span></code></pre></figure> <p>We assiged the <code class="highlighter-rouge">koa</code> module to <code class="highlighter-rouge">app</code>, <code class="highlighter-rouge">fs</code> module to <code class="highlighter-rouge">fs</code> and <code class="highlighter-rouge">co-request</code> module to <code class="highlighter-rouge">request</code>. The file <code class="highlighter-rouge">/ssl/cert.pem</code> is read and saved to <code class="highlighter-rouge">cert</code>. Similarly, value of <code class="highlighter-rouge">key</code> and <code class="highlighter-rouge">ca</code> is set. We have the IP and port to access the Remote API in the environment variable <code class="highlighter-rouge">DOCKER_HOST</code> in the format <code class="highlighter-rouge">tcp://&lt;ip&gt;:&lt;port&gt;</code>. We strip out the <code class="highlighter-rouge">tcp://</code> part of it and save it to <code class="highlighter-rouge">host</code> variable. So, if the value of the environment variable <code class="highlighter-rouge">DOCKER_HOST</code> is <code class="highlighter-rouge">tcp://192.168.99.100:2376</code>, the value of <code class="highlighter-rouge">host</code> will be <code class="highlighter-rouge">192.168.99.100:2376</code>.</p> <p>Now we have to write the function that handles all the requests. We accept GET request with container ID as the URL parameter. So the request <code class="highlighter-rouge">GET /9d65f58cca99</code> will be accepted and the container ID is <code class="highlighter-rouge">9d65f58cca99</code>. The function looks like the following.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">!==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>    
    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">'/containers/'</span><span class="o">+</span><span class="nx">container</span><span class="o">+</span><span class="s1">'/json'</span><span class="p">,</span>
      <span class="na">cert</span><span class="p">:</span> <span class="nx">cert</span><span class="p">,</span>
      <span class="na">key</span><span class="p">:</span> <span class="nx">key</span><span class="p">,</span>
      <span class="na">ca</span><span class="p">:</span> <span class="nx">ca</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">'/containers/create'</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">Config</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">Hostname</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">HostConfig</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">HostConfig</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">init</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

      <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">'/containers/'</span><span class="o">+</span><span class="nx">init</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">Id</span><span class="o">+</span><span class="s1">'/start'</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'done'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'invalid container id'</span><span class="p">;</span> 
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'container id missing'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure> <p>First of all, we check if there is any URL parameter. If there is no parameter, we send a <code class="highlighter-rouge">400 BAD REQUEST</code> response. Or else, we take the container ID from the URL, save it in <code class="highlighter-rouge">container</code> variable and continue. We send a <code class="highlighter-rouge">GET /containers/&lt;id&gt;/json</code> request to the Docker Remote API to get the configuration of the given image using the <code class="highlighter-rouge">cert</code>, <code class="highlighter-rouge">key</code> and <code class="highlighter-rouge">ca</code> variables for authentication. The URL for this is <code class="highlighter-rouge">'https://'+host+'/containers/'+container+'/json'</code>.</p> <p>If the response code for this request is not 200, we send a <code class="highlighter-rouge">404 NOT FOUND</code> response. This happens when the container ID is invalid. If the response code is 200, we continue. Now, we have to send a <code class="highlighter-rouge">POST /containers/create</code> request. The body of this request must contain the configuration of the Docker Image that we wish to create. As we are going to duplicate the image, whose ID was given, this can be obtained from the reponse of the previous request. The body of this request is composed of the <code class="highlighter-rouge">Config</code> object of the previous response.</p> <p>Now we need to empty the value of <code class="highlighter-rouge">Hostname</code> parameter in the body. This is done so that the newly created image will have a unique hostname which is the substring of its ID. Now we have to set the <code class="highlighter-rouge">HostConfig</code> parameter in the request body. This is be obtained from the <code class="highlighter-rouge">HostConfig</code> object in the previous reponse. Now we send this <code class="highlighter-rouge">POST /containers/create</code> request and the new container is created. The response from this request will contain the ID of the new container in the <code class="highlighter-rouge">Id</code> parameter.</p> <p>Now we send the <code class="highlighter-rouge">POST /containers/&lt;id&gt;/start</code> request to start this newly created container. The ID for this reqeust can be obtained from the previous response, so the URL will be <code class="highlighter-rouge">'https://'+host+'/containers/'+init.body.Id+'/start'</code>. This will start the new container and we can now send the <code class="highlighter-rouge">200 OK</code> response with <code class="highlighter-rouge">done</code> as the body.</p> <p>Finally, we need to make this app listen to the port <code class="highlighter-rouge">3000</code> using the command, <code class="highlighter-rouge">app.listen(3000)</code>. So the entire <code class="highlighter-rouge">server.js</code> file looks like this.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">)(),</span>
  <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">),</span>
  <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'co-request'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'/ssl/cert.pem'</span><span class="p">),</span>
  <span class="nx">key</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'/ssl/key.pem'</span><span class="p">),</span>
  <span class="nx">ca</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'/ssl/ca.pem'</span><span class="p">),</span>
  <span class="nx">host</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DOCKER_HOST</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">!==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>    
    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">'/containers/'</span><span class="o">+</span><span class="nx">container</span><span class="o">+</span><span class="s1">'/json'</span><span class="p">,</span>
      <span class="na">cert</span><span class="p">:</span> <span class="nx">cert</span><span class="p">,</span>
      <span class="na">key</span><span class="p">:</span> <span class="nx">key</span><span class="p">,</span>
      <span class="na">ca</span><span class="p">:</span> <span class="nx">ca</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">'/containers/create'</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">Config</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">Hostname</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">HostConfig</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">HostConfig</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">init</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

      <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">host</span><span class="o">+</span><span class="s1">'/containers/'</span><span class="o">+</span><span class="nx">init</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">Id</span><span class="o">+</span><span class="s1">'/start'</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'done'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'invalid container id'</span><span class="p">;</span> 
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'container id missing'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span></code></pre></figure> <h2 id="nginx-configuration">NGINX Configuration</h2> <p>We are using NGINX as the reverse proxy to our Node.js Application. NGINX is also used for SSL termination and client authentication. The encrypted requests will be received by the NGINX server, the SSL will be terminated and the plain-text requests will be forwarded to our Node.js server running at port <code class="highlighter-rouge">3000</code>. The configuration file <code class="highlighter-rouge">nginx.conf</code> look like this.</p> <figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">worker_processes</span>  <span class="mi">1</span><span class="p">;</span>
<span class="k">pid</span> <span class="n">/var/run/nginx.pid</span><span class="p">;</span>

<span class="k">events</span> <span class="p">{</span>
  <span class="kn">worker_connections</span>  <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">http</span> <span class="p">{</span>
  <span class="kn">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>

    <span class="kn">ssl_certificate</span> <span class="n">/ssl/cert.pem</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="n">/ssl/key.pem</span><span class="p">;</span>
    <span class="kn">ssl_client_certificate</span> <span class="n">/ssl/ca.pem</span><span class="p">;</span>
    <span class="kn">ssl_verify_client</span> <span class="no">on</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
      <span class="kn">add_header</span>          <span class="s">Access-Control-Allow-Origin</span> <span class="s">*</span><span class="p">;</span>
      <span class="kn">add_header</span>          <span class="s">Access-Control-Allow-Methods</span> <span class="s">GET</span><span class="p">;</span>
      <span class="kn">proxy_pass</span>          <span class="s">http://127.0.0.1:3000/</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span>    <span class="s">X-Real-IP</span>         <span class="nv">$remote_addr</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span>    <span class="s">X-Forwarded-For</span>   <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span>    <span class="s">X_FORWARDED_PROTO</span> <span class="s">https</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span>    <span class="s">Host</span>              <span class="nv">$http_host</span><span class="p">;</span>
      <span class="kn">proxy_buffering</span>     <span class="no">off</span><span class="p">;</span>
      <span class="kn">proxy_redirect</span>      <span class="no">off</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>NGINX listens to port 443 with SSL turned on. As, port 443 is the default port for SSL, we can now access this service with <code class="highlighter-rouge">https</code> without any ports. We authenticate the clients using the files <code class="highlighter-rouge">cert.pem</code>, <code class="highlighter-rouge">key.pem</code> and <code class="highlighter-rouge">ca.pem</code> in the <code class="highlighter-rouge">/ssl</code> folder. We use the <code class="highlighter-rouge">proxy_pass</code> parameter to pass these requests to the Node.js server listening at port <code class="highlighter-rouge">3000</code>.</p> <h2 id="replicator-dockerfile">Replicator Dockerfile</h2> <p>We need to have both Node.js and NGINX to be running inside the docker image. So we will write a script <code class="highlighter-rouge">start.sh</code> which acts as our entry point.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>

nginx -g <span class="s1">'daemon off;'</span> &amp;
npm start</code></pre></figure> <p>Our Docker Image will be based on Alpine Linux with Node.js server and NGINX running in it. We need to put the four files <code class="highlighter-rouge">package.json</code>, <code class="highlighter-rouge">server.js</code>, <code class="highlighter-rouge">nginx.conf</code> and <code class="highlighter-rouge">start.sh</code> into a folder named <code class="highlighter-rouge">files</code>. Create the <code class="highlighter-rouge">Dockerfile</code> in the folder containing this <code class="highlighter-rouge">files</code> folder and it will contain the following.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">FROM</span> <span class="n">mhart</span><span class="o">/</span><span class="n">alpine</span><span class="o">-</span><span class="n">node</span><span class="o">:</span><span class="mi">6</span>

<span class="n">RUN</span> <span class="n">apk</span> <span class="n">add</span> <span class="o">--</span><span class="n">update</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span> <span class="n">nginx</span>

<span class="n">ADD</span> <span class="n">files</span><span class="o">/</span><span class="n">package</span><span class="p">.</span><span class="n">json</span> <span class="n">files</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">js</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">RUN</span> <span class="n">npm</span> <span class="n">install</span>

<span class="n">ADD</span> <span class="n">files</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span>
<span class="n">ADD</span> <span class="n">files</span><span class="o">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span>
<span class="n">RUN</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span>

<span class="n">EXPOSE</span> <span class="mi">443</span>
<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s">"/bin/start.sh"</span><span class="p">]</span></code></pre></figure> <p>The base image is <code class="highlighter-rouge">mhart/alpine-node:6</code>, which is based on Alpine Linux and contains Node.js v6. We install nginx using Alpine Pacakge Manager, <code class="highlighter-rouge">apk</code>. We move the files <code class="highlighter-rouge">package.json</code> and <code class="highlighter-rouge">server.js</code> to the folder <code class="highlighter-rouge">/code</code> in the image and it will act as the working directory. We run <code class="highlighter-rouge">npm install</code> in this location to install all Node.js dependencies from <code class="highlighter-rouge">package.json</code>.</p> <p>Next, we move the file <code class="highlighter-rouge">nginx.conf</code> to <code class="highlighter-rouge">/etc/nginx</code> folder and <code class="highlighter-rouge">start.sh</code> to <code class="highlighter-rouge">/bin</code> folder. We make the <code class="highlighter-rouge">start.sh</code> executable with <code class="highlighter-rouge">chmod</code> command. The port <code class="highlighter-rouge">443</code> will be exposed and accessible from outside. This port is listened by NGINX. Finally, we set the <code class="highlighter-rouge">start.sh</code> file as the entry point to this image. You can build this image with the command <code class="highlighter-rouge">docker build -t replicator .</code>.</p> <h2 id="testing">Testing</h2> <p>To send requests to the replicator from inside a running container, the replicator must run in the same network. If the container name of the replicator image is <code class="highlighter-rouge">replicator</code>, we can send request to <code class="highlighter-rouge">https://replicator</code>. We also need to provide the container ID as the URL parameter. This value can be accessed from the environment variable <code class="highlighter-rouge">HOSTNAME</code>.</p> <p>For authentication of this request, we need to provide the certificate file (cert.pem) and its private key (key.pem). If <code class="highlighter-rouge">curl</code> is installed in the image and the authentication files are in <code class="highlighter-rouge">/ssl</code> folder, we can make this request using the following command.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl --insecure --cert /ssl/cert.pem --key /ssl/key.pem <span class="s2">"https://replicator/</span><span class="nv">$HOSTNAME</span><span class="s2">"</span></code></pre></figure> <p>To test the working of this replicator image, I have made a docker image. This docker image contains a Node.js server that server an HTML page with a button. If the button is clicked, the above <code class="highlighter-rouge">curl</code> command is executed. I have built it into a docker image, <a href="https://hub.docker.com/r/hanzel/node-replicate/">hanzel/node-replicate</a> and its code can be found <a href="https://github.com/botleg/node-replicate">here</a>. With this image, we can see that everytime we click the button a new instance of this service will be spun up. We will be deploying all this to a Docker Swarm now.</p> <h2 id="creating-the-swarm">Creating the Swarm</h2> <p>We will be using <a href="https://docs.docker.com/machine/">Docker Machine</a> to create and manage remote hosts as a swarm. With Docker Machine, you can create hosts on your local machine or your cloud provider. Check <a href="https://docs.docker.com/machine/drivers/">this link</a> to see the drivers supported by Docker Machine.</p> <p>You need to have the following installed in you local computer:</p> <ul> <li><code class="highlighter-rouge">Docker</code>: version &gt;= 1.10, to support Docker Compose File version 2 and Multi-Host networking.</li> <li><code class="highlighter-rouge">Docker Machine</code>: version &gt;= 0.6</li> <li><code class="highlighter-rouge">Docker Compose</code>: version &gt;= 1.6, to support Docker Compose file version 2</li> </ul> <p>You can create the virtual hosts in you local system if you have <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> installed. For this demonstration, I will be using <a href="https://www.digitalocean.com/">DigitalOcean</a>.</p> <p>The first thing we need to do is to create the Docker Swarm using Docker Machine and set it up. I have explained how to do this in the article, <a href="/stories/load-balancing-with-docker-swarm/">Load Balancing with Docker Swarm</a>. Follow the steps from <code class="highlighter-rouge">Initial Setup</code> to <code class="highlighter-rouge">The Swarm</code> of that article to create and setup the Swarm.</p> <p>Once the swarm is setup, you can see the hosts with <code class="highlighter-rouge">docker-machine ls</code> command. The output of this command must look something like this.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">NAME     ACTIVE      DRIVER         STATE     URL                          SWARM             DOCKER
consul   -           digitalocean   Running   tcp://104.131.23.60:2376                       v1.11.2
master   <span class="k">*</span> <span class="o">(</span>swarm<span class="o">)</span>   digitalocean   Running   tcp://104.131.109.181:2376   master <span class="o">(</span>master<span class="o">)</span>   v1.11.2
slave    -           digitalocean   Running   tcp://45.55.243.156:2376     master            v1.11.2 </code></pre></figure> <h2 id="key-distribution">Key Distribution</h2> <p>For the replicator image to access the Docker Remote API, it needs the certificate file (cert.pem), private key (key.pem) and certificate authority file (ca.pem). As we are using Docker Machine, the value in the environment variable <code class="highlighter-rouge">DOCKER_CERT_PATH</code> is the path of the folder containing these files. We are also going to use these same files to authenticate requests coming to the replicator. So we need to have these three files in the <code class="highlighter-rouge">replicator</code> and <code class="highlighter-rouge">node-replicate</code> image.</p> <p>Before moving the files to the Docker images, we need to get the files to all the remote hosts that we create with Docker Machine. We create a new folder name <code class="highlighter-rouge">ssl</code> and copy the required three file to this folder.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir ssl
cp <span class="nv">$DOCKER_CERT_PATH</span>/cert.pem <span class="nv">$DOCKER_CERT_PATH</span>/key.pem <span class="nv">$DOCKER_CERT_PATH</span>/ca.pem ssl/</code></pre></figure> <p>We now use <code class="highlighter-rouge">docker-machine scp</code> command to copy the contents of <code class="highlighter-rouge">ssl</code> folder to <code class="highlighter-rouge">/home/ssl</code> folder in the remote hosts <code class="highlighter-rouge">master</code> and <code class="highlighter-rouge">slave</code>.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker-machine scp -r ssl master:/home/ssl
docker-machine scp -r ssl slave:/home/ssl</code></pre></figure> <p>If you have more remote hosts, just repeat these commands by changing the host name. Once these files are in the remote hosts, you can create volumes that point from <code class="highlighter-rouge">/home/ssl</code> in the host to <code class="highlighter-rouge">/ssl</code> in the container, to bring these files into the containers.</p> <h2 id="running-with-docker-compose">Running with Docker Compose</h2> <p>We will test the working of the replicator using Docker Compose. The configuration file <code class="highlighter-rouge">docker-compose.yml</code> looks like the following.</p> <figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">version</span>: <span class="s1">'2'</span>

<span class="n">networks</span>:
  <span class="n">web</span>:
    <span class="n">driver</span>: <span class="n">overlay</span>

<span class="n">services</span>:
  <span class="n">replicator</span>:
    <span class="n">image</span>: <span class="n">hanzel</span>/<span class="n">replicator</span>
    <span class="n">container_name</span>: <span class="n">replicator</span>
    <span class="n">ports</span>:
      - <span class="s2">"443:443"</span>
    <span class="n">environment</span>:
      - <span class="n">constraint</span>:<span class="n">node</span>==<span class="n">slave</span>
      - <span class="n">DOCKER_HOST</span>=${<span class="n">DOCKER_HOST</span>}
    <span class="n">volumes</span>:
      - /<span class="n">home</span>/<span class="n">ssl</span>:/<span class="n">ssl</span>
    <span class="n">networks</span>:
      - <span class="n">web</span>

  <span class="n">lb</span>:
    <span class="n">image</span>: <span class="n">hanzel</span>/<span class="n">load</span>-<span class="n">balancing</span>-<span class="n">swarm</span>
    <span class="n">container_name</span>: <span class="n">lb</span>
    <span class="n">ports</span>:
      - <span class="s2">"80:80"</span>
    <span class="n">environment</span>:
      - <span class="n">constraint</span>:<span class="n">node</span>==<span class="n">master</span>
      - <span class="n">APP_NAME</span>=<span class="n">node</span>-<span class="n">replicate</span>
      - <span class="n">CONSUL_URL</span>=${<span class="n">KV_IP</span>}:<span class="m">8500</span>
    <span class="n">depends_on</span>:
      - <span class="n">web</span>
    <span class="n">networks</span>:
      - <span class="n">web</span>

  <span class="n">web</span>:
    <span class="n">image</span>: <span class="n">hanzel</span>/<span class="n">node</span>-<span class="n">replicate</span>
    <span class="n">ports</span>:
      - <span class="s2">"3000"</span>
    <span class="n">volumes</span>:
      - /<span class="n">home</span>/<span class="n">ssl</span>:/<span class="n">ssl</span>
    <span class="n">networks</span>:
      - <span class="n">web</span></code></pre></figure> <p>We have an overlay network <code class="highlighter-rouge">web</code> that contains all the services. The first service is the <code class="highlighter-rouge">replicator</code> and uses <code class="highlighter-rouge">hanzel/replicator</code> image. We give the name <code class="highlighter-rouge">replicator</code> for this container and export the port <code class="highlighter-rouge">443</code>. This make the replicator accessible at <code class="highlighter-rouge">https://replicator</code>. We set the <code class="highlighter-rouge">constraint:node</code> environment variable to <code class="highlighter-rouge">slave</code> so that this container always runs in the <code class="highlighter-rouge">slave</code> remote host. As discussed above, we need to set the <code class="highlighter-rouge">DOCKER_HOST</code> environment variable to the URL to access the Remote API. This is set in the <code class="highlighter-rouge">DOCKER_HOST</code> environment variable set by the <code class="highlighter-rouge">docker-machine</code>. We also need to create a Docker Volume from <code class="highlighter-rouge">/home/ssl</code> in the host to <code class="highlighter-rouge">/ssl</code> in the container to share the certificates and keys.</p> <p>The second service is a load balancer which can distibuted the traffic to different instances of the same image. To know more about this service, read my article <a href="/stories/load-balancing-with-docker-swarm/">Load Balancing with Docker Swarm</a>. The third service is named <code class="highlighter-rouge">web</code> and contains the image <code class="highlighter-rouge">hanzel/node-replicate</code> that was created to test the replicator. It listens to port <code class="highlighter-rouge">3000</code>, so it is exposed. As this service make requests to the replicator, it need the same certificates and keys for authentication. This is done by creating a docker volume similar to <code class="highlighter-rouge">replicator</code> service.</p> <p>Make sure that your docker client is connected to the swarm with <code class="highlighter-rouge">eval $(docker-machine env -swarm master)</code> command. Now open up the terminal in the folder containing <code class="highlighter-rouge">docker-compose.yml</code> and start the services using the following command.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></figure> <p>This will start these services. You can see the running containers with the command <code class="highlighter-rouge">docker-compose ps</code>. The output of the command must look like this.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">Name         Command         State   Ports           
------------------------------------------------------------------------
lb           /bin/start.sh   Up      443/tcp, 104.131.109.181:80-&gt;80/tcp
replicator   /bin/start.sh   Up      104.131.109.181:443-&gt;443/tcp
tmp_web_1    npm start       Up      45.55.243.156:32772-&gt;3000/tcp</code></pre></figure> <p>We can see the application from the url given by the command, <code class="highlighter-rouge">docker-compose port lb 80</code>. You will get some IP address like <code class="highlighter-rouge">104.131.109.181:80</code>. Go to this url and we can see the running app. To test the <code class="highlighter-rouge">replicator</code>, click on the <code class="highlighter-rouge">Replicate</code> button. This sends a request to replicator with the current containerâ€™s ID and the replicator will create a new service similar to this and deploy it. Once all that is done, the text <code class="highlighter-rouge">done</code> appears in the webpage.</p> <p>Check again the running services with <code class="highlighter-rouge">docker-compose ps</code> command and we can see two instances of our <code class="highlighter-rouge">node-replicate</code> images running.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">Name                Command         State   Ports           
------------------------------------------------------------------------
lb                  /bin/start.sh   Up      443/tcp, 104.131.109.181:80-&gt;80/tcp
replicator          /bin/start.sh   Up      104.131.109.181:443-&gt;443/tcp
reverent_dubinsky   npm start       Up      45.55.243.156:32773-&gt;3000/tcp
tmp_web_1           npm start       Up      45.55.243.156:32772-&gt;3000/tcp</code></pre></figure> <p>Here, the container named <code class="highlighter-rouge">reverent_dubinsky</code> in the new one replicated. Everytime we press the button, a new instance will be deployed. You can also send the request to replicator externally. You need to have the certificate and key file in the <code class="highlighter-rouge">ssl</code> folder. Run the command <code class="highlighter-rouge">docker ps</code> to get the list of running container. Pick the required container and note its ID. Now run the following command to replicate this container.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl --insecure --cert ssl/cert.pem --key ssl/key.pem <span class="s2">"https://</span><span class="k">$(</span>docker-machine ip slave<span class="k">)</span><span class="s2">/&lt;container-id&gt;"</span>

<span class="c"># Example: If the container ID is 'd44f756ca3a1'</span>
curl --insecure --cert ssl/cert.pem --key ssl/key.pem <span class="s2">"https://</span><span class="k">$(</span>docker-machine ip slave<span class="k">)</span><span class="s2">/d44f756ca3a1"</span></code></pre></figure> <p>Run this command or press the button a few times and the output of <code class="highlighter-rouge">docker-compose ps</code> will look something like this.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">Name                Command         State                  Ports
-------------------------------------------------------------------------------
drunk_borg          npm start       Up      104.131.109.181:32770-&gt;3000/tcp
hungry_banach       npm start       Up      104.131.109.181:32769-&gt;3000/tcp
kickass_hoover      npm start       Up      45.55.243.156:32775-&gt;3000/tcp
lb                  /bin/start.sh   Up      443/tcp, 104.131.109.181:80-&gt;80/tcp
replicator          /bin/start.sh   Up      104.131.109.181:443-&gt;443/tcp
reverent_dubinsky   npm start       Up      45.55.243.156:32773-&gt;3000/tcp
sleepy_williams     npm start       Up      45.55.243.156:32774-&gt;3000/tcp
tmp_web_1           npm start       Up      45.55.243.156:32772-&gt;3000/tcp </code></pre></figure> <p>You can still use the <code class="highlighter-rouge">docker-compose scale</code> command to manually scale the services. Also, you can see that the load balancer is also updated with the new instances. You can see the load balancer configuration with the command <code class="highlighter-rouge">docker exec -t lb cat /etc/nginx/conf.d/default.conf</code>. Its output looks something like this.</p> <figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">upstream</span> <span class="s">node-replicate</span> <span class="p">{</span>
  <span class="kn">least_conn</span><span class="p">;</span>

  <span class="kn">server</span> <span class="nf">10.132.11.48</span><span class="p">:</span><span class="mi">32770</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
  <span class="kn">server</span> <span class="nf">10.132.11.48</span><span class="p">:</span><span class="mi">32769</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
  <span class="kn">server</span> <span class="nf">10.132.69.218</span><span class="p">:</span><span class="mi">32775</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
  <span class="kn">server</span> <span class="nf">10.132.69.218</span><span class="p">:</span><span class="mi">32773</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
  <span class="kn">server</span> <span class="nf">10.132.69.218</span><span class="p">:</span><span class="mi">32774</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
  <span class="kn">server</span> <span class="nf">10.132.69.218</span><span class="p">:</span><span class="mi">32772</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">80</span> <span class="s">default</span><span class="p">;</span>

  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://node-replicate</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <h2 id="conclusion">Conclusion</h2> <p>In this article, we can set up an auto-scaling system with Docker using Docker Remote API. This can be used to scale the service as the traffic increases. We have made a docker image to that replicates services and tested it on an app deployed with Docker Swarm.</p> <p>Once you are done, the services can be stopped and the hosts removed with the following commands.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker-compose down
docker-machine stop consul master slave
docker-machine rm consul master slave</code></pre></figure> <p class="post-meta">Tags: auto-scaling, replicator, remote, API, docker, machine, swarm, registrator, nginx, digitalocean, compose, machine, bash, Dockerfile, Node.js, nginx, and devops </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside class="post-aside"> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/blue-green-deployment-with-docker/>Building Blue-Green Deployment with Docker</a><br/><a href=/stories/load-balancing-with-docker-swarm/>Load Balancing with Docker Swarm</a><br/><a href=/stories/docker-hosting-with-sloppyio/>Docker Hosting with sloppy.io</a><br/><a href=/stories/orchestrate-docker-containers-with-tutum/>Orchestrate Docker containers with Tutum</a><br/><a href=/stories/share-your-localhost/>Share your localhost</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading"><a href="/">botleg</a></h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li> <a href="https://github.com/botleg"> <span class="footer-icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#gh"></use> </svg> </span> <span class="username">github</span> </a> </li> <li class="username"> <span class="footer-icon"> <svg viewBox="0 0 24 24" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg> </span> subscribe <a href="/feed">via RSS</a> </li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, devops, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <style type="text/css">body,h1,h2{font-weight:300}.wrapper:after{clear:both}html{box-sizing:border-box}body{background-color:#fdfdfd;color:#111;font-family:Helvetica,Arial,sans-serif;font-size:18px;line-height:1.6;}.wrapper section{margin-top:30px}a{color:#2a7ae2;text-decoration:none}.site-header{min-height:60px;position:relative}.site-title{margin-bottom:0;float:left;font-size:28px;line-height:60px;text-transform:lowercase;color:#e8e8e8}.post-header{box-align:center;justify-content:center;color:#fdfdfd;display:flex;height:300px;margin-bottom:10px}.rss-icon,#searchbox{display:none;}.post-header .header-content{text-align:center;max-width:600px}.icon{background-position:10px center;background-repeat:no-repeat;background-size:30px;padding:0 30px 0 45px}.icon span{color:#fdfdfd;display:none}@media screen and (min-width:400px){.icon span{display:inline}}.post-title{color:#e8e8e8;font-size:36px}.page-content,.post-content{margin-bottom:20px}.page-content h2,.post-content h2{font-size:32px}</style> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v310'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script async type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
