<!DOCTYPE html> <html> <head> <title>Developing in AWS Lambda with Serverless Framework - botleg</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Serverless or Function as a Service, in a nutshell, is composed of some function and events configured for it. When the event is triggered, the function will..."> <meta name="author" content="Hanzel Jesheen"> <meta name="twitter:card" content="Leverage the serverless approach to create a highly parallel application in AWS Lambda with Serverless Framework" /> <meta name="twitter:site" content="@HanzelJesheen" /> <meta name="twitter:creator" content="@HanzelJesheen" /> <meta property="og:url" content="https://botleg.com/stories/developing-in-aws-lambda-with-serverless-framework/" /> <meta property="og:type" content="article" /> <meta property="og:title" content="Developing in AWS Lambda with Serverless Framework" /> <meta property="og:description" content="Leverage the serverless approach to create a highly parallel application in AWS Lambda with Serverless Framework" /> <meta property="og:image" content="" /> <meta property="og:site_name" content="botleg" /> <meta property="article:author" content="Hanzel Jesheen" /> <meta itemprop="name" content="Developing in AWS Lambda with Serverless Framework"> <meta itemprop="description" content="Serverless or Function as a Service, in a nutshell, is composed of some function and events configured for it. When the event is triggered, the function will..."> <link rel="canonical" href="https://botleg.com/stories/developing-in-aws-lambda-with-serverless-framework/"> <link rel="alternate" type="application/rss+xml" title="botleg" href="https://botleg.com/feed" /> </head> <body> <div class="page-content"> <div class="post"> <header style="background:#FF512F;background-image:linear-gradient(160deg, #FF512F, #F09819);background-image:-moz-linear-gradient(160deg, #FF512F, #F09819);background-image:-webkit-linear-gradient(160deg, #FF512F, #F09819);background-image:-o-linear-gradient(160deg, #FF512F, #F09819);background-image:-ms-linear-gradient(160deg, #FF512F, #F09819);"> <section class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <a href="/feed/index.xml"><span class="rss-icon"> <svg viewBox="0 0 24 24" width="30px" height="30px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg></span> </a> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </section> <section class="post-header"> <div class="header-content"> <h1 class="post-title">Developing in AWS Lambda with Serverless Framework</h1> <a class="icon gh" href="https://github.com/botleg/serverless-ping" target="blank"><span>View Code</span></a> </div> </section> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on May 30, 2017 | <a href="/categories/cloud">cloud</a> </p> <p>Serverless or <code class="highlighter-rouge">Function as a Service</code>, in a nutshell, is composed of some function and events configured for it. When the event is triggered, the function will be executed and whatever is returned by the function becomes the output. You are only charged for the time your function is executing. This is currently the highest level of abstration available. You don’t have to worry about deploying or scaling the function. By definition, High Availability and Auto-Scaling is built into the application.</p> <p><a href="http://aws.amazon.com/">AWS</a> came up with the first serverless service called <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> and it is currently the biggest player in the space. With Lambda, you can write functions in Node.js, Python, Java and even C#. You are charged for every 100ms the code is executing. It is also connected to other services within AWS ecosystem. Other popular services are Google Cloud Functions, Azure Functions and Apache OpenWhisk.</p> <p>In this article, we will create a sample application using AWS Lambda and Serverless framework to find latency between different regions within AWS. The code for this application can be found <a href="https://github.com/botleg/serverless-ping">here</a>.</p> <h2 id="why-serverless-framework">Why Serverless Framework?</h2> <p><a href="https://serverless.com/">Serverless</a> is a framework that helps with the development in serverless platforms. In the traditional development with AWS Lambda, you need to write the function, add the dependencies, archive all the files to a <code class="highlighter-rouge">.zip</code> file and upload it in the console and setup its configurations. This is not a streamlined approach for Serverless development. The following are some of the problems that this method has, which can be solved using Serverless Framework.</p> <h1 id="hard-to-deploy">Hard to deploy</h1> <p>Every time, you make some changes, you would have to archive the files to a <code class="highlighter-rouge">.zip</code> file and upload it. This process is even more difficult if you have multiple dependent functions or services. Once you have setup the serverless framework, you can deploy the latest version of the code with the a single command, <code class="highlighter-rouge">sls deploy</code>.</p> <h1 id="no-declarative-configuration">No declarative configuration</h1> <p>If you are configuring the lambda functions from the AWS console, you have to fill a lot of fields up. You also have to go to a bunch of other services and set it all up. This makes it difficult to share your code. The functions will come with long set of steps for its configuration and deployment. With serverless framework, you can provide all the configuration related to the functions in a file called <code class="highlighter-rouge">serverless.yml</code>. This file will contain the information about the service provider and all the functions. You can also add additional resources needed for the functions in the file.</p> <h1 id="hard-to-test-locally">Hard to test locally</h1> <p>With the console way, you can’t really test the functions locally before deploying it. With serverless framework, you can invoke the functions manually with the <code class="highlighter-rouge">sls invoke</code> command. If the function name is <code class="highlighter-rouge">test</code>, you can invoke it locally with <code class="highlighter-rouge">sls invoke local -f test</code>. You can also run the version deployed in the AWS using the command, <code class="highlighter-rouge">sls invoke -f test</code>. If you need to pass any JSON data to the functions, you can save the data to a file and give its path with the <code class="highlighter-rouge">sls invoke</code> command. So, if the data file is <code class="highlighter-rouge">data.json</code> and it is in the same folder as <code class="highlighter-rouge">serverless.yml</code>, the command becomes <code class="highlighter-rouge">sls invoke local -f test -p data.json</code></p> <h1 id="hard-to-get-logs">Hard to get logs</h1> <p>With the console method, you have to go the CloudWatch and watch the logs. In the serverless framework, you can see the logs with the command, <code class="highlighter-rouge">sls logs</code>. To see the logs for the function <code class="highlighter-rouge">test</code> for the last 5 minutes, you can use the command <code class="highlighter-rouge">sls logs -f test --startTime 5m</code>. You can also stream the logs to the console using <code class="highlighter-rouge">sls logs -f test -t</code>.</p> <p>These are some of the issue that serverless framework solves for you. When you run the <code class="highlighter-rouge">sls deploy</code> command, the following things happen:</p> <ul> <li>The entire code base is archived to a <code class="highlighter-rouge">.zip</code> file.</li> <li>A <code class="highlighter-rouge">S3 bucket</code> is created and the archived file is uploaded to it.</li> <li>In the case of AWS, the framework reads the <code class="highlighter-rouge">serverless.yml</code> file and creates corresponding <code class="highlighter-rouge">CloudFormation</code> templates. This templates will contain the instructions to create lambda functions using the archived file from S3 bucket. It will also included the addtional resources and policies that is present in the <code class="highlighter-rouge">serverless.yml</code> file.</li> <li>The template created is pushed to the S3 bucket and it is executed. This creates all the functions and dependent services.</li> </ul> <h2 id="installing-serverless-framework">Installing Serverless Framework</h2> <p><a href="https://serverless.com/">Serverless</a> is essentially an <code class="highlighter-rouge">Node.js CLI</code> and it is available as a <code class="highlighter-rouge">NPM</code> package. So, you need to have Node.js and npm installed in the system. If it is not already installed, check <a href="https://nodejs.org/en/download/">here</a> to download the latest version. Once Node.js and npm is installed, you can install serverless framework with,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">npm install -g serverless</code></pre></figure> <p>You can now use the serverless framwork using the command <code class="highlighter-rouge">serverless</code> or <code class="highlighter-rouge">sls</code>. Now, you need to connect your AWS account to serverless. For this, you need to have <code class="highlighter-rouge">AWS Access Keys</code>. To generate these, you can check <a href="http://docs.aws.amazon.com/general/latest/gr/managing-aws-access-keys.html">here</a>. You will now have an <code class="highlighter-rouge">Access Key ID</code> and a <code class="highlighter-rouge">Secret Access Key</code>. Now you can associate serverless with your AWS account with the command,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">serverless config credentials --provider aws --key &lt;Access Key ID&gt; --secret &lt;Secret Access Key&gt;</code></pre></figure> <h2 id="demo-application">Demo Application</h2> <p>Now, we are ready to start developing in AWS Lambda with serverless framework. We will build a sample application that does <code class="highlighter-rouge">ping</code> test to see the latency between different regions with AWS. We will deploy the application in one region and we can see the latency from that region to other regions. The result of the <code class="highlighter-rouge">ping</code> tests will be stored in a S3 bucket. As the input, we will use a <code class="highlighter-rouge">JSON</code> file with the list of regions and end-points. The code for this application is in <code class="highlighter-rouge">javascript</code> and the runtime used is <code class="highlighter-rouge">Node.js 6.10</code>.</p> <p><img src="/assets/images/ping-arch@2x.jpg" srcset="/assets/images/ping-arch@1x.jpg 300w, /assets/images/ping-arch@2x.jpg 600w, /assets/images/ping-arch@3x.jpg 900w" sizes="(min-width: 960px) 900px, 100vw" alt="Demo Application Architecture" class="center-image" /> <em class="image-caption">Demo Application Architecture</em></p> <p>All the ping tests are independent to others, so we can run it in parallel. To do this, we use AWS <a href="https://aws.amazon.com/sns">Simple Notification Service (SNS)</a>. SNS is bascially a notification service from AWS. With SNS, we can have multiple topics and each topic can have multiple subscribers. When a message is published to the topic, all its subscribers are notified. Here, we use one lambda function called <code class="highlighter-rouge">list</code> to read from the input and publish message for each item in the data to a SNS topic. The second function, <code class="highlighter-rouge">ping</code> becomes the subscriber for this topic. So each message published to the SNS topic will trigger lambda functions that will run in parallel. All these lambda function will run ping test for one region and stores the result in a S3 bucket.</p> <h2 id="list-function">List Function</h2> <p>List function should read from the JSON data and publish each entry as a message to a SNS topic. The data file <code class="highlighter-rouge">data.js</code> looks this,</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'N.Virginia'</span>      <span class="p">:</span> <span class="s1">'ec2.us-east-1.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Ohio'</span>            <span class="p">:</span> <span class="s1">'ec2.us-east-2.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'N.California'</span>    <span class="p">:</span> <span class="s1">'ec2.us-west-1.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Oregon'</span>          <span class="p">:</span> <span class="s1">'ec2.us-west-2.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Canada'</span>          <span class="p">:</span> <span class="s1">'ec2.ca-central-1.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Frankfurt'</span>       <span class="p">:</span> <span class="s1">'ec2.eu-central-1.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'London'</span>          <span class="p">:</span> <span class="s1">'ec2.eu-west-2.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Singapore'</span>       <span class="p">:</span> <span class="s1">'ec2.ap-southeast-1.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Sydney'</span>          <span class="p">:</span> <span class="s1">'ec2.ap-southeast-2.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'Mumbai'</span>          <span class="p">:</span> <span class="s1">'ec2.ap-south-1.amazonaws.com'</span><span class="p">,</span>
  <span class="s1">'SãoPaulo'</span>        <span class="p">:</span> <span class="s1">'ec2.sa-east-1.amazonaws.com'</span>
<span class="p">}</span></code></pre></figure> <p>We have a object with the region names as the keys and its URL endpoint as the values. We will be doing the ping test to the endpoints and save the results in S3 bucket as files named with the region name. This is just sample data that points to the <code class="highlighter-rouge">EC2</code> endpoint in each region. The javascript file that contains the main function, <code class="highlighter-rouge">index.js</code> is given below.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s1">'use strict'</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'aws-sdk'</span><span class="p">),</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./data'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">split</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">invokedFunctionArn</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">),</span>
        <span class="nx">topic</span> <span class="o">=</span> <span class="err">`</span><span class="na">arn</span><span class="p">:</span><span class="na">aws</span><span class="p">:</span><span class="na">sns</span><span class="p">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">split</span><span class="p">[</span><span class="mi">3</span><span class="p">]}:</span><span class="nx">$</span><span class="p">{</span><span class="nx">split</span><span class="p">[</span><span class="mi">4</span><span class="p">]}:</span><span class="nx">$</span><span class="p">{</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOPIC_NAME</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
        <span class="nx">sns</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">SNS</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sns</span><span class="p">.</span><span class="nx">publish</span><span class="p">({</span>
      <span class="na">Message</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="na">region</span><span class="p">:</span> <span class="nx">item</span><span class="p">,</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
      <span class="p">}),</span>
      <span class="na">TopicArn</span><span class="p">:</span> <span class="nx">topic</span>
    <span class="p">}).</span><span class="nx">promise</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure> <p>The code will be run on <code class="highlighter-rouge">Node.js 6.10</code> runtime and it is in <a href="http://es6-features.org/">ES6</a>. So, we start by choosing <code class="highlighter-rouge">strict</code> mode. We will import <code class="highlighter-rouge">aws-sdk</code> to publish messages to SNS and the data file, <code class="highlighter-rouge">data.js</code>. The <code class="highlighter-rouge">handler</code> function is the one that should be executed when the event is triggered. It receives three paramaters:</p> <ul> <li><code class="highlighter-rouge">event</code>: This will contain information related to the event that triggered this function. If the event configured in an <code class="highlighter-rouge">API Gateway</code> endpoint, you receive the URL, request headers and so on.</li> <li><code class="highlighter-rouge">context</code>: This will contain the information about the AWS account that runs the function. You can fetch your AWS account number and region from this.</li> <li><code class="highlighter-rouge">callback</code>: This is a function that should be called to return values from the function. In the case of <code class="highlighter-rouge">API Gateway</code> event, this is where you will provide the response.</li> </ul> <p>The first thing we do in the function is to get the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">ARN</a> for the SNS topic that we need to publish to. This will be in the format <code class="highlighter-rouge">arn:aws:sns:&lt;region&gt;:&lt;account number&gt;:&lt;topic name&gt;</code>. We are parsing the <code class="highlighter-rouge">context</code> object to get the <code class="highlighter-rouge">account number</code> and the <code class="highlighter-rouge">region</code>. We are getting the <code class="highlighter-rouge">topic name</code> from environment variables. We will talk more about this while writing <code class="highlighter-rouge">serverless.yml</code> file. Now, for every <code class="highlighter-rouge">key</code> in the data, we will publish a new message to SNS topic. We use the <code class="highlighter-rouge">sns.publish()</code> function for this. The <code class="highlighter-rouge">Message</code> will contain region name as <code class="highlighter-rouge">region</code> and endpoint as <code class="highlighter-rouge">url</code>, converted to string. Also <code class="highlighter-rouge">TopicArn</code> parameter will contain the topic name. We will also apply a <code class="highlighter-rouge">catch</code> clause for error handling. Finally, as we don’t have to return anything from this function, we end with <code class="highlighter-rouge">callback(null)</code>. Put both <code class="highlighter-rouge">data.js</code> and <code class="highlighter-rouge">index.js</code> in the folder <code class="highlighter-rouge">list</code> placed in the root of the project.</p> <h2 id="ping-function">Ping Function</h2> <p>The <code class="highlighter-rouge">ping</code> function is triggered by the SNS topic. Each instance of the function will act on one message or one region. It will receive the endpoint for one region and the ping test is done on it. The result is then saved into a S3 bucket with the region name as the file name. This function is given below in the file <code class="highlighter-rouge">index.js</code>.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s1">'use strict'</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">),</span>
      <span class="nx">ping</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">'tcp-ping'</span><span class="p">).</span><span class="nx">ping</span><span class="p">),</span>
      <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'aws-sdk'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">&amp;&amp;</span> <span class="s1">'Records'</span> <span class="k">in</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Sns</span><span class="p">.</span><span class="nx">Message</span><span class="p">);</span>

    <span class="nx">ping</span><span class="p">({</span> <span class="na">address</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">url</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">s3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">S3</span><span class="p">();</span>
      <span class="nx">s3</span><span class="p">.</span><span class="nx">putObject</span><span class="p">({</span>
        <span class="na">Bucket</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BUCKET_NAME</span><span class="p">,</span>
        <span class="na">Key</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">region</span><span class="p">,</span>
        <span class="na">Body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">promise</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">));</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></figure> <p>We start by importing <code class="highlighter-rouge">tcp-ping</code> to do the ping test, <code class="highlighter-rouge">bluebird</code> to <a href="http://bluebirdjs.com/docs/api/promise.promisify.html">promisify</a> the ping test and <code class="highlighter-rouge">aws-sdk</code> to write the result to S3. As before, <code class="highlighter-rouge">handler</code> is the function triggered by the event. The message received from the SNS topic will be found at <code class="highlighter-rouge">event.Records[0].Sns.Message</code> and we parse it to <code class="highlighter-rouge">body</code>. We will do the ping test on the endpoint, <code class="highlighter-rouge">body.url</code> with <code class="highlighter-rouge">ping</code> function.</p> <p>We now have to write the result of the ping test to the S3 bucket. For that, we will create a new <code class="highlighter-rouge">S3</code> object and call its <code class="highlighter-rouge">putObject</code> method. The <code class="highlighter-rouge">Bucket</code> name is obtained from the environment variable. The <code class="highlighter-rouge">Key</code>, or the file name, is the region name and is found at <code class="highlighter-rouge">body.region</code>. The <code class="highlighter-rouge">Body</code> of the file is the result of the ping test as a string. As before, we add a couple of <code class="highlighter-rouge">catch</code> clauses for error handling. Put this file <code class="highlighter-rouge">index.js</code> inside the folder <code class="highlighter-rouge">ping</code> placed in the project root.</p> <h2 id="serverless-files">Serverless Files</h2> <p>To manage the dependencies of this Node.js project, we need to have a <code class="highlighter-rouge">package.json</code> file. We are using <code class="highlighter-rouge">aws-sdk</code>, <code class="highlighter-rouge">bluebird</code> and <code class="highlighter-rouge">tcp-ping</code> as the <code class="highlighter-rouge">npm</code> dependencies. So the <code class="highlighter-rouge">package.json</code> file will look like this.</p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"serverless-ping"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"aws-sdk"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^2.55.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"bluebird"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.5.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"tcp-ping"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.1.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Now, we come to the <code class="highlighter-rouge">serverless.yml</code> file. The configuration file of this project for serverles framework. It will contain configuration related to the service provider and each function. It also includes any additional resources needed for the project. To know more about this file, check <a href="https://serverless.com/framework/docs/providers/aws/guide/serverless.yml/">here</a>. The file for this project looks like this.</p> <figure class="highlight"><pre><code class="language-config" data-lang="config"><span class="n">service</span>: <span class="n">ServerlessPing</span>
<span class="n">custom</span>: ${<span class="n">file</span>(<span class="n">env</span>.<span class="n">yml</span>)}

<span class="n">provider</span>:
  <span class="n">name</span>: <span class="n">aws</span>
  <span class="n">stage</span>: <span class="n">dev</span>
  <span class="n">runtime</span>: <span class="n">nodejs6</span>.<span class="m">10</span>
  <span class="n">region</span>: <span class="n">us</span>-<span class="n">west</span>-<span class="m">2</span>
  <span class="n">environment</span>: ${<span class="n">file</span>(<span class="n">env</span>.<span class="n">yml</span>)}
  <span class="n">iamRoleStatements</span>:
    - <span class="n">Effect</span>: <span class="s1">'Allow'</span>
      <span class="n">Action</span>: <span class="s1">'SNS:Publish'</span>
      <span class="n">Resource</span>:
        <span class="n">Fn</span>::<span class="n">Join</span>:
          - <span class="s1">':'</span>
          - - <span class="s1">'arn:aws:sns'</span>
            - <span class="n">Ref</span>: <span class="s1">'AWS::Region'</span>
            - <span class="n">Ref</span>: <span class="s1">'AWS::AccountId'</span>
            - ${<span class="n">self</span>:<span class="n">custom</span>.<span class="n">TOPIC_NAME</span>}
    - <span class="n">Effect</span>: <span class="s1">'Allow'</span>
      <span class="n">Action</span>: <span class="s1">'S3:PutObject'</span>
      <span class="n">Resource</span>:
        <span class="n">Fn</span>::<span class="n">Join</span>:
          - <span class="s1">''</span>
          - - <span class="s1">'arn:aws:s3:::'</span>
            - ${<span class="n">self</span>:<span class="n">custom</span>.<span class="n">BUCKET_NAME</span>}
            - <span class="s1">'/*'</span>

<span class="n">functions</span>:
  <span class="n">list</span>:
    <span class="n">handler</span>: <span class="n">list</span>.<span class="n">handler</span>

  <span class="n">ping</span>:
    <span class="n">handler</span>: <span class="n">ping</span>.<span class="n">handler</span>
    <span class="n">events</span>:
      - <span class="n">sns</span>: ${<span class="n">self</span>:<span class="n">custom</span>.<span class="n">TOPIC_NAME</span>}

<span class="n">resources</span>:
  <span class="n">Resources</span>:
    <span class="n">PingBucket</span>:
      <span class="n">Type</span>: <span class="n">AWS</span>::<span class="n">S3</span>::<span class="n">Bucket</span>
      <span class="n">Properties</span>:
<span class="n">BucketName</span>: ${<span class="n">self</span>:<span class="n">custom</span>.<span class="n">BUCKET_NAME</span>}</code></pre></figure> <p>We start with the project name, <code class="highlighter-rouge">ServerlessPing</code> in this case. We can add custom variables from external files to this file. We use this to setup environment variables and to use those values in this file. This lets us store secret values within the project that we don’t want to share with the code. In this case, we have a file for environment variables called <code class="highlighter-rouge">env.yml</code>. This file looks like below:</p> <figure class="highlight"><pre><code class="language-config" data-lang="config"><span class="n">TOPIC_NAME</span>: <span class="n">ping</span>
<span class="n">BUCKET_NAME</span>: <span class="n">awspingdump</span></code></pre></figure> <p>Here, the <code class="highlighter-rouge">TOPIC_NAME</code> refers to the name of the SNS topic and the <code class="highlighter-rouge">BUCKET_NAME</code> refers to the S3 bucket to store the results in. As all the S3 buckets should have a unique name, you would have to change the <code class="highlighter-rouge">BUCKET_NAME</code> to something else. To refer to these values in the <code class="highlighter-rouge">serverless.yml</code>, we use the <code class="highlighter-rouge">custom</code> key which is directed to the <code class="highlighter-rouge">env.yml</code> file.</p> <p>With the <code class="highlighter-rouge">provider</code> object in <code class="highlighter-rouge">serverless.yml</code>, we will setup configuration related to the service provider. These are common for all functions. Here, the <code class="highlighter-rouge">name</code> of the provider is <code class="highlighter-rouge">aws</code> and the stage is currently <code class="highlighter-rouge">dev</code>. As the function goes for production, you can change <code class="highlighter-rouge">stage</code> to <code class="highlighter-rouge">prod</code>. As the code is javascript, we ues <code class="highlighter-rouge">Node.js 6.10</code> as the runtime. Also, we set the region to deploy the function as <code class="highlighter-rouge">us-west-2</code>. To move it to some other region, just change this field. We also need to use the file <code class="highlighter-rouge">env.yml</code> to set the environment variables. For this, we use the <code class="highlighter-rouge">environment</code> field and we point it to external file <code class="highlighter-rouge">env.yml</code>.</p> <p>Next, we will set the <code class="highlighter-rouge">iamRoleStatements</code>. This is to set permission to be applied to the functions. In our case, we need the function to able to publish to SNS topic and put files in S3. To know more about this, check <a href="https://serverless.com/framework/docs/providers/aws/guide/iam/">here</a>. For each entry in <code class="highlighter-rouge">iamRoleStatements</code>, we need to mention three fields: <code class="highlighter-rouge">Effect</code> which could be <code class="highlighter-rouge">Allow</code> or <code class="highlighter-rouge">Deny</code>, <code class="highlighter-rouge">Action</code> and <code class="highlighter-rouge">Resource</code> name.</p> <p>The first statement is to be able to publish to SNS. The <code class="highlighter-rouge">Effect</code> is <code class="highlighter-rouge">Allow</code> and <code class="highlighter-rouge">Action</code> is <code class="highlighter-rouge">SNS:Publish</code>. As discussed before, the name of topic is in the format <code class="highlighter-rouge">arn:aws:sns:&lt;region&gt;:&lt;account number&gt;:&lt;topic name&gt;</code>. To construct this, we use <code class="highlighter-rouge">Fn::Join</code> which joins the list of items with a <code class="highlighter-rouge">delimiter</code>, which is <code class="highlighter-rouge">:</code> in this case. We start with <code class="highlighter-rouge">arn:aws:sns</code>, to which we append AWS region name with <code class="highlighter-rouge">Ref: 'AWS::Region'</code> and AWS account number with <code class="highlighter-rouge">Ref: 'AWS::AccountId'</code>. Finally, we also append the topic name obtained from the <code class="highlighter-rouge">env.yml</code> file, which is read from the custom field. This can obtainer with <code class="highlighter-rouge">${self:custom.TOPIC_NAME}</code>.</p> <p>The second statement is to be able to put files into S3 bucket. The <code class="highlighter-rouge">Effect</code> is <code class="highlighter-rouge">Allow</code> and <code class="highlighter-rouge">Action</code> is <code class="highlighter-rouge">S3:PutObject</code>. To give permission to write to a bucket, we need to give resource name in the format <code class="highlighter-rouge">arn:aws:s3:::&lt;bucket name&gt;/*</code>. As before, we will construct this using <code class="highlighter-rouge">Fn::Join</code>, but now the delimiter is blank. We start with <code class="highlighter-rouge">arn:aws:s3:::</code>, to which we append the bucket name from the <code class="highlighter-rouge">custom</code> field, with <code class="highlighter-rouge">${self:custom.BUCKET_NAME}</code> and <code class="highlighter-rouge">/*</code>.</p> <p>After the provider configuration, we set up configuration for each function. The first function is <code class="highlighter-rouge">list</code>. Handler for this function is <code class="highlighter-rouge">handler</code> in the file <code class="highlighter-rouge">index.js</code> in the <code class="highlighter-rouge">list</code> folder, so that is given as <code class="highlighter-rouge">list.handler</code>. For this demo, we will run this function manually with <code class="highlighter-rouge">sls invoke</code> command. You can set up a variety of events for each functions. You can see more about events <a href="https://serverless.com/framework/docs/providers/aws/guide/events/">here</a>.</p> <p>The second function is <code class="highlighter-rouge">ping</code>. As before, the handler for it is <code class="highlighter-rouge">handler</code> within <code class="highlighter-rouge">index.js</code> in <code class="highlighter-rouge">ping</code> folder. So, handler becomes <code class="highlighter-rouge">ping.handler</code>. This function is to be triggered by the SNS topic. which makes the event <code class="highlighter-rouge">sns</code>. The topic name is obtained from the <code class="highlighter-rouge">custom</code> field, so the topic name is <code class="highlighter-rouge">${self:custom.TOPIC_NAME}</code>.</p> <p>Finally, we need to provision a S3 bucket to store the results. We add the <code class="highlighter-rouge">resources</code> object to this file for this. We have a resource named <code class="highlighter-rouge">PingBucket</code>, which is a S3 bucket or <code class="highlighter-rouge">AWS::S3::Bucket</code>. For properties, we give the name of the bucket from the value in the <code class="highlighter-rouge">custom</code> field: <code class="highlighter-rouge">${self:custom.BUCKET_NAME}</code>.</p> <h2 id="deploying-application">Deploying Application</h2> <p>Place the files <code class="highlighter-rouge">serverless.yml</code>, <code class="highlighter-rouge">env.yml</code> and <code class="highlighter-rouge">package.json</code> in the project the root. It should also contain the <code class="highlighter-rouge">list</code> and <code class="highlighter-rouge">ping</code> folder. We can import the dependencies with the command,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">npm install</code></pre></figure> <p>We are now ready to deploy this application, which can done with a single command.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sls deploy</code></pre></figure> <p>This will archive the project file and push it to S3; create the necessary cloudformation template to deploy the function and events; and create the additional S3 bucket. After the deploy is done, you can see the Lambda jobs, SNS topics, and S3 buckets created. If you make any changes, you can deploy the changes with the same <code class="highlighter-rouge">sls deploy</code> command. We will now manually trigger the <code class="highlighter-rouge">list</code> function, which will trigger multiple <code class="highlighter-rouge">ping</code> functions and fill up the S3 bucket with ping test results.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sls invoke -f list</code></pre></figure> <p>Now if you check the S3 bucket, you can see the files for each region. Each file will contain the JSON result of the ping test of that region.</p> <p><img src="/assets/images/s3-dump@2x.jpg" srcset="/assets/images/s3-dump@1x.jpg 300w, /assets/images/s3-dump@2x.jpg 600w, /assets/images/s3-dump@3x.jpg 900w" sizes="(min-width: 960px) 900px, 100vw" alt="Ping results in S3" class="center-image" /> <em class="image-caption">Ping results in S3</em></p> <h2 id="conclusion">Conclusion</h2> <p>In this article, we have made an introduction to serverless with AWS Lambda and Serverless framework. We have also designed an application to leverage the advantages provided by the serverless approach and deployed it using serverless framework to AWS Lambda. This approach can be used in a wide variety of use-cases to get high-available application at a fraction of the cost.</p> <p>You can remove the complete function off AWS with the command <code class="highlighter-rouge">sls remove</code>. This will remove the functions, events and any additional resources.</p> <p class="post-meta">Tags: serverless, lambda, aws, sns, faas, ping, arn, s3, and cloud </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside class="post-aside"> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> <a href="/categories/crypto">Crypto</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/hello-world/>hello world :)</a><br/><a href=/stories/implement-elasticsearch-in-jekyll-blog/>Implement Elasticsearch in Jekyll blog</a><br/><a href=/stories/build-and-deploy-to-openshift-with-travisci-and-wercker/>Build and Deploy to OpenShift with TravisCI and Wercker</a><br/><a href=/stories/using-your-sessions-with-socketio/>Using your sessions with Socket.IO</a><br/><a href=/stories/line-numbers-in-jekyll-code-blocks/>Line numbers in Jekyll code blocks</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading"><a href="/">botleg</a></h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li> <a href="https://github.com/botleg"> <span class="footer-icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#gh"></use> </svg> </span> <span class="username">github</span> </a> </li> <li class="username"> <span class="footer-icon"> <svg viewBox="0 0 24 24" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg> </span> subscribe <a href="/feed">via RSS</a> </li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, devops, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <style type="text/css">body,h1,h2{font-weight:300}.wrapper:after{clear:both}html{box-sizing:border-box}body{background-color:#fdfdfd;color:#111;font-family:Helvetica,Arial,sans-serif;font-size:18px;line-height:1.6;}.wrapper section{margin-top:30px}a{color:#2a7ae2;text-decoration:none}.site-header{min-height:60px;position:relative}.site-title{margin-bottom:0;float:left;font-size:28px;line-height:60px;text-transform:lowercase;color:#e8e8e8}.post-header{box-align:center;justify-content:center;color:#fdfdfd;display:flex;height:300px;margin-bottom:10px}.rss-icon,#searchbox{display:none;}.post-header .header-content{text-align:center;max-width:600px}.icon{background-position:10px center;background-repeat:no-repeat;background-size:30px;padding:0 30px 0 45px}.icon span{color:#fdfdfd;display:none}@media screen and (min-width:400px){.icon span{display:inline}}.post-title{color:#e8e8e8;font-size:36px}.page-content,.post-content{margin-bottom:20px}.page-content h2,.post-content h2{font-size:32px}</style> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v310'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script async type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
