<!DOCTYPE html> <html> <head> <title>Local Cryptocurrency Wallet that doesn't store anything - botleg</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content=" A cryptocurrency (or crypto currency) is a digital asset designed to work as a medium of exchange that uses cryptography to secure its transactions, to con..."> <meta name="author" content="Hanzel Jesheen"> <meta name="twitter:card" content="Create a command-line wallet that stores cryptocurrencies, like bitcoin and ethereum, with just a 12 word phrase" /> <meta name="twitter:site" content="@HanzelJesheen" /> <meta name="twitter:creator" content="@HanzelJesheen" /> <meta property="og:url" content="https://botleg.com/stories/local-cryptocurrency-wallet-that-doesnt-store-anything/" /> <meta property="og:type" content="article" /> <meta property="og:title" content="Local Cryptocurrency Wallet that doesn't store anything" /> <meta property="og:description" content="Create a command-line wallet that stores cryptocurrencies, like bitcoin and ethereum, with just a 12 word phrase" /> <meta property="og:image" content="" /> <meta property="og:site_name" content="botleg" /> <meta property="article:author" content="Hanzel Jesheen" /> <meta itemprop="name" content="Local Cryptocurrency Wallet that doesn't store anything"> <meta itemprop="description" content=" A cryptocurrency (or crypto currency) is a digital asset designed to work as a medium of exchange that uses cryptography to secure its transactions, to con..."> <link rel="canonical" href="https://botleg.com/stories/local-cryptocurrency-wallet-that-doesnt-store-anything/"> <link rel="alternate" type="application/rss+xml" title="botleg" href="https://botleg.com/feed" /> </head> <body> <div class="page-content"> <div class="post"> <header style="background:#22C1C3;background-image:linear-gradient(160deg, #22C1C3, #FDBB2D);background-image:-moz-linear-gradient(160deg, #22C1C3, #FDBB2D);background-image:-webkit-linear-gradient(160deg, #22C1C3, #FDBB2D);background-image:-o-linear-gradient(160deg, #22C1C3, #FDBB2D);background-image:-ms-linear-gradient(160deg, #22C1C3, #FDBB2D);"> <section class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <a href="/feed/index.xml"><span class="rss-icon"> <svg viewBox="0 0 24 24" width="30px" height="30px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg></span> </a> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </section> <section class="post-header"> <div class="header-content"> <h1 class="post-title">Local Cryptocurrency Wallet that doesn't store anything</h1> <a class="icon gh" href="https://github.com/botleg/cryptonym" target="blank"><span>View Code</span></a> </div> </section> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Apr 24, 2018 | <a href="/categories/crypto">crypto</a> </p> <blockquote> <p>A cryptocurrency (or crypto currency) is a digital asset designed to work as a medium of exchange that uses cryptography to secure its transactions, to control the creation of additional units, and to verify the transfer of assets.</p> </blockquote> <p>You may have a variety of crypto-currencies stored in different places like exchanges or wallet. In this article, we will create our own command-line wallet that stores bitcoin, ethereum, bitcoin cash, litecoin, erc20 tokens, stellar, etc. This will be a local wallet that doesn’t share any private information with the internet. It also doesn’t store anything on disc.</p> <p>All you need to have is a 12 word phrase that lets you generate the public and private keys for your accounts. This supports HD wallets that lets you create a new address for every transaction. I’ll talk more about HD wallets next. This application only lets you receive coins and check balance. To send money, you need to export the private keys from this application and use it in dedicated wallets. This application is called <strong>Cryptonym</strong> and the code can be found <a href="https://github.com/botleg/cryptonym">here</a>.</p> <h2 id="hd-wallet">HD Wallet</h2> <p>With HD (Hierarchical Deterministic) wallet, you can generate as many address and private/public keys as you want from a single phrase. All you need is a <a href="https://en.bitcoin.it/wiki/Mnemonic_phrase">mnemonic phrase</a>, from which we will generate the seed. From the seed, we can generate the multiple private/public keys and address. The cool thing about HD wallets is that we can create the keys for not only bitcoin, but also for a range of other coins.</p> <p>From the seed, you can generate the keys using a derivation path. The derivation path has the following format,</p> <figure class="highlight"><pre><code class="language-text" data-lang="text">m / purpose' / coin_type' / account' / change / address_index</code></pre></figure> <p>To know more about this format, check <a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki#path-levels">here</a>. For example, value for <code class="highlighter-rouge">coin_type</code> is <strong>0</strong> for <strong>bitcoin</strong> and <strong>60</strong> for <strong>ethereum</strong>. We will increment the <code class="highlighter-rouge">address_index</code> to get new addresses. To know more about the working of HD wallets, check <a href="https://bitcoinmagazine.com/articles/deterministic-wallets-advantages-flaw-1385450276/">here</a>.</p> <h2 id="application-overview">Application Overview</h2> <p>This will be a <a href="https://nodejs.org/">Node.js</a> application that you can run in the command line terminal. So, the only dependency for this is Node.js with version <strong>&gt;= 9.0</strong>. The code for the application can be found in <a href="https://github.com/botleg/cryptonym">github</a>. Once the repository is cloned, dependencies can be installed with <code class="highlighter-rouge">npm install</code>. To run this as a standalone application, you can use <code class="highlighter-rouge">npm link</code> command. This will create a symlink for this application (app.js) in the global package folder. This lets you access the application with <code class="highlighter-rouge">cryptonym</code> command. To know more about <strong>npm link</strong>, check <a href="https://docs.npmjs.com/cli/link">here</a>.</p> <p>So, the commands to setup and run the wallet are as follows,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone git@github.com:hanzeljesheen/cryptonym.git
<span class="nb">cd </span>cryptonym
npm install
npm link
cryptonym</code></pre></figure> <p>The entrypoint to the application is <code class="highlighter-rouge">app.js</code> and it looks like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="cp">#!/usr/bin/env node
</span><span class="s1">'use strict'</span>

<span class="kr">const</span> <span class="nx">bip39</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bip39'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">chalk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chalk'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">clear</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cli-clear'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">inquirer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'inquirer'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">Prompt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utils/prompt'</span><span class="p">);</span>

<span class="p">(</span><span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">prompt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Prompt</span><span class="p">(</span><span class="nx">inquirer</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">mnemonic</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">prompt</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="s1">'Mnemonic Phrase (leave empty to generate one)'</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">mnemonic</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Mnemonic</span> <span class="nx">Phrase</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="nx">bip39</span><span class="p">.</span><span class="nx">generateMnemonic</span><span class="p">())}</span><span class="err">`</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Save</span> <span class="k">this</span> <span class="nx">phrase</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">safe</span> <span class="nx">place</span> <span class="nx">and</span> <span class="nx">use</span> <span class="nx">it</span> <span class="nx">from</span> <span class="nx">now</span> <span class="nx">on</span><span class="p">.</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span><span class="p">(</span><span class="s1">'This phrase will never be generated again.'</span><span class="p">)}</span><span class="err">`</span><span class="p">)</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bip39</span><span class="p">.</span><span class="nx">validateMnemonic</span><span class="p">(</span><span class="nx">mnemonic</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span><span class="s1">'✗ Invalid Mnemonic Phrase'</span><span class="p">))</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">clear</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">.</span><span class="nx">blue</span><span class="p">(</span><span class="s1">'CRYPTONYM\n'</span><span class="p">))</span>

  <span class="kr">const</span> <span class="nx">seed</span> <span class="o">=</span> <span class="nx">bip39</span><span class="p">.</span><span class="nx">mnemonicToSeed</span><span class="p">(</span><span class="nx">mnemonic</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">coin</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">prompt</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="s1">'Select Coin'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'Bitcoin'</span><span class="p">,</span> <span class="s1">'Bitcoin Cash'</span><span class="p">,</span> <span class="s1">'Ether'</span><span class="p">,</span> <span class="s1">'Golem'</span><span class="p">,</span> <span class="s1">'Litecoin'</span><span class="p">,</span> <span class="s1">'Request Token'</span><span class="p">,</span> <span class="s1">'SONM'</span><span class="p">,</span> <span class="s1">'Stellar Lumen'</span><span class="p">,</span> <span class="s1">'Streamr DATAcoin'</span> <span class="p">])</span>
  <span class="kr">const</span> <span class="nx">lib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="err">`</span><span class="p">.</span><span class="o">/</span><span class="nx">coins</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">coin</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/g</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()}</span><span class="err">`</span><span class="p">)</span>

  <span class="nx">await</span> <span class="nx">lib</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">prompt</span><span class="p">)</span>
<span class="p">})()</span></code></pre></figure> <p>First, we’ll ask the user to enter their <code class="highlighter-rouge">mnemonic phrase</code>. For our purpose, we use and accept a <strong>12 word phrase</strong>. This is <strong>never</strong> saved in the application or disc. So, it has to entered for every execution. If the user doesn’t have a mnemonic phrase, one will be generated. This has to be saved offline (in a paper) and can be used in the subsequent executions. Once the phrase is verified, the seed is generated from this. The seed is used along with the derivation path to generate all the keys and addresses. We will then provide a list of coins that the user can choose. Currently, the following coins are supported,</p> <ul> <li><a href="https://bitcoin.org/">Bitcoin</a></li> <li><a href="https://www.bitcoincash.org/">Bitcoin Cash</a></li> <li><a href="https://www.ethereum.org/">Ether</a></li> <li><a href="https://golem.network/">Golem</a></li> <li><a href="https://litecoin.org/">Litecoin</a></li> <li><a href="https://request.network/">Request Token</a></li> <li><a href="https://sonm.io/">SONM</a></li> <li><a href="https://www.stellar.org/">Stellar Lumen</a></li> <li><a href="https://www.streamr.com/">Streamr DATAcoin</a></li> </ul> <p>There is a utility function for each coin which will be triggered based on the user choice.</p> <h2 id="working-of-hd-wallet">Working of HD Wallet</h2> <p>With the help of HD wallets, we can create as many keys and address as we want. However, only the bitcoin and its forks (litecoin and bitcoin cash) will let you transfer coins from more than one account with just one transaction. For other coins, you need to use multiple transactions to move money out from different accounts. So, we will generate a new address for each transaction in the case of bitcoin and its forks. For other coins, we will just use a single address.</p> <p>The utility function for <strong>bitcoin</strong> is present in <code class="highlighter-rouge">coins/bitcoin.js</code> and its utility class is in <code class="highlighter-rouge">utils/btc.js</code>. The utility function looks like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="s1">'use strict'</span>
<span class="kr">const</span> <span class="nx">bitcoin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bitcoinjs-lib'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">chalk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chalk'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">BTC</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../utils/btc'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">prompt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">bitcoin</span><span class="p">.</span><span class="nx">HDNode</span><span class="p">.</span><span class="nx">fromSeedBuffer</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">coin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTC</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">option</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">prompt</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="s1">'Menu'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'View Balance'</span><span class="p">,</span> <span class="s1">'Generate New Address'</span><span class="p">,</span> <span class="s1">'Show Extended Private Key'</span><span class="p">,</span> <span class="s1">'Exit'</span> <span class="p">])</span>

  <span class="k">switch</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'View Balance'</span><span class="p">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'checking...'</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">coin</span><span class="p">.</span><span class="nx">balance</span><span class="p">()</span>
      <span class="kr">const</span> <span class="nx">balance</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100000000</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Total</span> <span class="nx">Balance</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="nx">balance</span> <span class="o">+</span> <span class="s1">' BTC'</span><span class="p">)}</span><span class="err">`</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nb">Number</span> <span class="nx">of</span> <span class="nx">Transcations</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span><span class="err">`</span><span class="p">)</span>
      <span class="k">break</span>

    <span class="k">case</span> <span class="s1">'Generate New Address'</span><span class="p">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'generating...'</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">address</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">coin</span><span class="p">.</span><span class="nx">generate</span><span class="p">()</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Bitcoin</span> <span class="nx">Address</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="nx">address</span><span class="p">)}</span><span class="err">`</span><span class="p">)</span>
      <span class="k">break</span>

    <span class="k">case</span> <span class="s1">'Show Extended Private Key'</span><span class="p">:</span>
      <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">coin</span><span class="p">.</span><span class="nx">privates</span><span class="p">()</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Extended</span> <span class="nx">Private</span> <span class="nx">Key</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="nx">key</span><span class="p">)}</span><span class="err">`</span><span class="p">)</span>
      <span class="k">break</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>From the seed, a <code class="highlighter-rouge">root HD node</code> is created and is passed over to a new <code class="highlighter-rouge">BTC</code> class instance. There are three options available under bitcoin,</p> <h1 id="view-balance">View Balance</h1> <p>This will let you check the balance across all the addresses generated from the seed. The function <code class="highlighter-rouge">balance</code> from the <strong>BTC</strong> class instance will give the total balance and the number of transactions made by all the accounts. The function looks like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">async</span> <span class="nx">balance</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">address</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="kd">let</span> <span class="nx">balance</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">let</span> <span class="nx">transcations</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">item</span> <span class="nx">of</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">address</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">derivePath</span><span class="p">(</span><span class="err">`</span><span class="nx">m</span><span class="o">/</span><span class="mi">44</span><span class="err">’</span><span class="o">/</span><span class="mi">0</span><span class="err">’</span><span class="o">/</span><span class="mi">0</span><span class="err">’</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">item</span><span class="p">}</span><span class="sr">/${index}`</span><span class="se">)</span><span class="sr">.getAddress</span><span class="se">(</span><span class="err">)
</span>      <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span>

      <span class="nx">balance</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">balance</span>
      <span class="nx">transcations</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">transcations</span>
      <span class="nx">index</span><span class="o">++</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcations</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">[</span> <span class="nx">balance</span><span class="p">,</span> <span class="nx">transcations</span> <span class="p">]</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="nx">check</span> <span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">axios</span><span class="p">(</span><span class="err">`</span><span class="nx">https</span><span class="err">:</span><span class="c1">//blockchain.info/balance?active=${address}`)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">address</span> <span class="k">in</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">balance</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">address</span><span class="p">][</span><span class="s1">'final_balance'</span><span class="p">],</span>
      <span class="na">transcations</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">address</span><span class="p">][</span><span class="s1">'n_tx'</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>To check the balance, we will generate an address and then check if there are any transactions made with that address. If so, we will add the balance of that address and generate the next one. This goes on till we find the address with no transactions. We need to do this for both external and change accounts.</p> <p>The <code class="highlighter-rouge">purpose</code> value of the derivation path is <strong>44</strong> as it’s used for <a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP-44 HD Wallet</a>. The <code class="highlighter-rouge">coin_type</code> value for bitcoin is <strong>0</strong>. We are generating the addresses for the first account, so the value of <code class="highlighter-rouge">account</code> is <strong>0</strong>. The derivation path therefore starts with <code class="highlighter-rouge">m/44'/0'/0'</code>. The value for <code class="highlighter-rouge">change</code> is <strong>0</strong> for <strong>external</strong> and <strong>1</strong> for <strong>change</strong> addresses. We will then increment the value of <code class="highlighter-rouge">address_index</code> from <strong>0</strong> to generate the addresses till we get one with no transactions.</p> <p>To get the balance and the number of transactions made, an API call is made to <a href="https://blockchain.info">blockchain.info</a>. We are only passing the public address to the internet. None of the private data gets online.</p> <h1 id="generate-new-address">Generate New Address</h1> <p>This will generate an address that you can share with people to receive coins from them. With the implementation of HD wallet, you can generate a new address for every transaction. The function <code class="highlighter-rouge">generate</code> from the <strong>BTC</strong> class instance will give the new address. The function look like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">async</span> <span class="nx">generate</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">address</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">do</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">derivePath</span><span class="p">(</span><span class="err">`</span><span class="nx">m</span><span class="o">/</span><span class="mi">44</span><span class="s1">'/0'</span><span class="o">/</span><span class="mi">0</span><span class="err">'</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span><span class="err">`</span><span class="p">).</span><span class="nx">getAddress</span><span class="p">()</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span>
    <span class="nx">index</span><span class="o">++</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcations</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">address</span>
<span class="p">}</span></code></pre></figure> <p>This works similar to the <code class="highlighter-rouge">View Balance</code> action. You need to generate an address and check the number of transactions made with it. This continues till you get an address that has no transactions. To share with people, you only use the <strong>external</strong> address, so the value for <code class="highlighter-rouge">change</code> is <strong>0</strong>.</p> <h1 id="show-extended-private-key">Show Extended Private Key</h1> <p>This application doesn’t let you send coins from your accounts outside. For this, you need to export the <code class="highlighter-rouge">extended private key</code> and import it in a dedicated wallet like <a href="https://electrum.org/#home">Electrum</a>. The function <code class="highlighter-rouge">privates</code> from the <strong>BTC</strong> class instance will give the extended private key. It looks like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">privates</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">derivePath</span><span class="p">(</span><span class="err">`</span><span class="nx">m</span><span class="o">/</span><span class="mi">44</span><span class="s1">'/0'</span><span class="o">/</span><span class="mi">0</span><span class="err">'`</span><span class="p">).</span><span class="nx">toBase58</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure> <p>As discussed above the derivation path for the <strong>first bitcoin account</strong> is <code class="highlighter-rouge">m/44'/0'/0'</code>. It is exported in <code class="highlighter-rouge">Base58</code> format. This can now be imported into bitcoin wallets.</p> <p>The forks of <strong>Bitcoin</strong>, like <strong>Litecoin</strong> and <strong>Bitcoin Cash</strong>, also work in same way. We will generate a new address for each transaction and generate the balance in similar fashion. The only change is in the endpoint that the API calls are made to.</p> <h2 id="erc20-tokens">ERC20 Tokens</h2> <p>Ethereum blockchain uses ether as the default token/coin. In addition to this, you can create and use other tokens with the ethereum blockchain. This is done using <code class="highlighter-rouge">ERC20 Smart Contracts</code> and the such coins are called <strong>ERC20 tokens</strong>. Each of these token has a corresponding contract with a hex address. For example, the contract for <strong>Golem</strong> is <code class="highlighter-rouge">0xa74476443119A942dE498590Fe1f2454d7D4aC0d</code>. You can use the same address to store ether and any ERC20 tokens. With HD wallet, you can generate multiple ethereum keys and addresses. The value for <code class="highlighter-rouge">coin_type</code> is 60 for ethereum. However, unlike bitcoin, you can’t transfer from more than one account in one transaction. So, we’ll just have a single address for each of the ERC20 tokens.</p> <p>For each of the token, we have a utility function that gets triggered. The function for <strong>Golem</strong> is at <code class="highlighter-rouge">coins/golem.js</code> and looks like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="s1">'use strict'</span>
<span class="kr">const</span> <span class="nx">ERC20</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../utils/erc20'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">prompt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ERC20</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="s1">'0xa74476443119A942dE498590Fe1f2454d7D4aC0d'</span><span class="p">)</span>
  <span class="nx">await</span> <span class="nx">token</span><span class="p">.</span><span class="nx">menu</span><span class="p">(</span><span class="nx">prompt</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure> <p>In this case, an object of the <code class="highlighter-rouge">ERC20</code> class, which is found in <code class="highlighter-rouge">utils/erc20.js</code>, is created with the <strong>seed</strong> and <strong>contract hex</strong>. In the case of <code class="highlighter-rouge">ether</code>, the contract hex is left blank as it’s the default token for the ethereum network. Once, the object is created, the <code class="highlighter-rouge">menu</code> function is called. The <code class="highlighter-rouge">ECR20</code> class looks like this,</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="s1">'use strict'</span>
<span class="kr">const</span> <span class="nx">bitcoin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bitcoinjs-lib'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">chalk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chalk'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">ethUtil</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ethereumjs-util'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'open'</span><span class="p">)</span>

<span class="kr">class</span> <span class="nx">ERC20</span> <span class="p">{</span>
  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">contract</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">contract</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">bitcoin</span><span class="p">.</span><span class="nx">HDNode</span><span class="p">.</span><span class="nx">fromSeedBuffer</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">derivePath</span><span class="p">(</span><span class="err">`</span><span class="nx">m</span><span class="o">/</span><span class="mi">44</span><span class="err">’</span><span class="o">/</span><span class="mi">60</span><span class="err">’</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">account</span><span class="p">}</span><span class="err">’</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="err">`</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">pvt</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">keyPair</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">ethUtil</span><span class="p">.</span><span class="nx">privateToAddress</span><span class="p">(</span><span class="nx">pvt</span><span class="p">)</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">ethUtil</span><span class="p">.</span><span class="nx">toChecksumAddress</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">))</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">contract</span> <span class="o">=</span> <span class="nx">contract</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pvt</span> <span class="o">=</span> <span class="nx">pvt</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Ethereum</span> <span class="nx">Address</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">address</span><span class="p">)}</span><span class="err">\</span><span class="nx">n</span><span class="err">`</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">hash</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">hash</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">str</span> <span class="o">=</span> <span class="s1">'0x0000000000000000000000000000000000000000'</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="kr">char</span> <span class="nx">of</span> <span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hash</span> <span class="o">=</span> <span class="p">((</span><span class="nx">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="nx">hash</span><span class="p">)</span> <span class="o">+</span> <span class="kr">char</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span>
      <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nx">hash</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">hash</span>
  <span class="p">}</span>

  <span class="nx">async</span> <span class="nx">menu</span> <span class="p">(</span><span class="nx">prompt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">option</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">prompt</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="s1">'Menu'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'View Balance'</span><span class="p">,</span> <span class="s1">'Show Private Key'</span><span class="p">,</span> <span class="s1">'Exit'</span> <span class="p">])</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">'View Balance'</span><span class="err">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contract</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">open</span><span class="p">(</span><span class="err">`</span><span class="nx">https</span><span class="err">:</span><span class="c1">//etherscan.io/token/${this.contract}?a=${this.address}`)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">open</span><span class="p">(</span><span class="err">`</span><span class="na">https</span><span class="p">:</span><span class="c1">//etherscan.io/address/${this.address}`)</span>
        <span class="p">}</span>
        <span class="k">break</span>

      <span class="k">case</span> <span class="s1">'Show Private Key'</span><span class="err">:</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Private Key '</span> <span class="o">+</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">green</span><span class="p">(</span><span class="nx">ethUtil</span><span class="p">.</span><span class="nx">addHexPrefix</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pvt</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">))))</span>
        <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ERC20</span></code></pre></figure> <p>When an object of <code class="highlighter-rouge">ERC20</code> class is created, we will generate the public address for that token. A hash function is applied to the <strong>contract hex</strong> to obtain the account number. This will ensure that a unique account is used for each token, which will give different addresses. In the case of <strong>ether</strong>, which doesn’t have a <strong>contract hex</strong>, hash of <code class="highlighter-rouge">0x0000000000000000000000000000000000000000</code> is used to determine its account.</p> <p>From the seed, a root node is created. In the derivation path, the value for <code class="highlighter-rouge">coin_type</code> is 60 for ethereum network. The <code class="highlighter-rouge">account</code> value is obtained from the hash value calculated just now. The concept of change address don’t really apply here, so we use the <strong>external</strong> address. So, the value of the <code class="highlighter-rouge">change</code> is <strong>0</strong>. Since we use only one account, the <code class="highlighter-rouge">address_index</code> value is set to 0. So the derivation path is <code class="highlighter-rouge">m/44'/60'/${account}'/0/0</code>. With this derivation path, we can obtain the address and public key for the token. For ethereum network, both address and the private key are in <strong>hex</strong> format. The public address is displayed now. This can be used to receive tokens.</p> <p>The <code class="highlighter-rouge">menu</code> function of the <code class="highlighter-rouge">ERC20</code> class provides the following two options,</p> <h1 id="view-balance-1">View Balance</h1> <p>To view the balance, we use <a href="https://etherscan.io/">etherscan.io</a>. In the case of ether, you only have to pass the address. For other tokens, you need to pass over the address and the contract. This link is then opened up in the browser.</p> <h1 id="show-private-key">Show Private Key</h1> <p>In the <code class="highlighter-rouge">constructor</code>, we had created derived the path of the account from the seed. From this, we can generate the private key. This is also exported in <strong>hex</strong> format. This private key can now be imported into dedicated ethereum wallets like <a href="https://www.myetherwallet.com/">MyEtherWallet</a> or <a href="https://metamask.io/">MetaMask</a> to send tokens out of this account.</p> <h2 id="conclusion">Conclusion</h2> <p>There is a HD wallet npm package for <a href="https://www.stellar.org/">Stellar Lumen</a>. So, I’ve included it as well into this. I welcome and request all contributions to this project to support more coins and add more functionality. Do check out the repository <a href="https://github.com/botleg/cryptonym">here</a>.</p> <p class="post-meta">Tags: cryptocurrency, blockchain, bitcoin, wallet, ethereum, litecoin, stellar, erc20, somn, golem, lumen, streamr, bitcoin-cash, bip44, javascript, node.js, and crypto </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside class="post-aside"> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> <a href="/categories/crypto">Crypto</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/implement-elasticsearch-in-jekyll-blog/>Implement Elasticsearch in Jekyll blog</a><br/><a href=/stories/auto-scaling-with-docker/>Auto Scaling with Docker</a><br/><a href=/stories/docker-hosting-with-sloppyio/>Docker Hosting with sloppy.io</a><br/><a href=/stories/orchestrate-docker-containers-with-tutum/>Orchestrate Docker containers with Tutum</a><br/><a href=/stories/share-your-localhost/>Share your localhost</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading"><a href="/">botleg</a></h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li> <a href="https://github.com/botleg"> <span class="footer-icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#gh"></use> </svg> </span> <span class="username">github</span> </a> </li> <li class="username"> <span class="footer-icon"> <svg viewBox="0 0 24 24" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg> </span> subscribe <a href="/feed">via RSS</a> </li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, devops, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <style type="text/css">body,h1,h2{font-weight:300}.wrapper:after{clear:both}html{box-sizing:border-box}body{background-color:#fdfdfd;color:#111;font-family:Helvetica,Arial,sans-serif;font-size:18px;line-height:1.6;}.wrapper section{margin-top:30px}a{color:#2a7ae2;text-decoration:none}.site-header{min-height:60px;position:relative}.site-title{margin-bottom:0;float:left;font-size:28px;line-height:60px;text-transform:lowercase;color:#e8e8e8}.post-header{box-align:center;justify-content:center;color:#fdfdfd;display:flex;height:300px;margin-bottom:10px}.rss-icon,#searchbox{display:none;}.post-header .header-content{text-align:center;max-width:600px}.icon{background-position:10px center;background-repeat:no-repeat;background-size:30px;padding:0 30px 0 45px}.icon span{color:#fdfdfd;display:none}@media screen and (min-width:400px){.icon span{display:inline}}.post-title{color:#e8e8e8;font-size:36px}.page-content,.post-content{margin-bottom:20px}.page-content h2,.post-content h2{font-size:32px}</style> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v310'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script async type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
