<!DOCTYPE html> <html> <head> <title>Orchestrate Docker containers with Tutum</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Tutum simplifies the process of hosting Docker containers. We can connect Tutum to our cloud provider and create node clusters. We can then deploy, scale and..."> <meta name="author" content="Hanzel Jesheen"> <meta itemprop="name" content="Orchestrate Docker containers with Tutum"> <meta itemprop="description" content="Tutum simplifies the process of hosting Docker containers. We can connect Tutum to our cloud provider and create node clusters. We can then deploy, scale and..."> <link rel="canonical" href="https://botleg.com/stories/orchestrate-docker-containers-with-tutum/"> <link rel="alternate" type="application/rss+xml" title="Botleg" href="https://botleg.com/feed" /> </head> <body> <header class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </header> <div class="page-content"> <div class="post"> <header class="post-header" style="background:rgb(52, 73, 94) 25%;background-image: linear-gradient(90deg, rgb(52, 73, 94) 25%, rgb(41, 128, 185) 100%);background-image: -moz-linear-gradient(left, rgb(52, 73, 94) 25%, rgb(41, 128, 185) 100%);background-image: -webkit-linear-gradient(left, rgb(52, 73, 94) 25%, rgb(41, 128, 185) 100%);background-image: -o-linear-gradient(left, rgb(52, 73, 94) 25%, rgb(41, 128, 185) 100%);background-image: -ms-linear-gradient(left, rgb(52, 73, 94) 25%, rgb(41, 128, 185) 100%);"> <div class="header-content"> <h1 class="post-title">Orchestrate Docker containers with Tutum</h1> <a class="icon gh" href="https://github.com/botleg/tutum-nodejs-redis" target="blank"><span>View Code</span></a> </div> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Feb 3, 2016 | <a href="/categories/devops">devops</a> </p> <p><a href="https://www.tutum.co/">Tutum</a> simplifies the process of hosting Docker containers. We can connect Tutum to our cloud provider and create node clusters. We can then deploy, scale and link Docker containers from the Tutum interface. In this article, we will see how to deploy a Node.js application with Redis as the data store. We will also scale this application and use load balacing. The entire code for this application can be found <a href="https://github.com/botleg/tutum-nodejs-redis">here</a>.</p> <h2 id="the-containers">The Containers</h2> <p>I have made a simple Node.js application that connects to Redis database and lets you to set and see the value of a key. We use the <a href="https://hub.docker.com/_/redis/">official image</a> for Redis. The app has three endpoints:</p> <ul> <li><code class="highlighter-rouge">/key</code>: Returns the value of the <code class="highlighter-rouge">key</code>.</li> <li><code class="highlighter-rouge">/key/value</code>: Sets the value of the <code class="highlighter-rouge">key</code> to <code class="highlighter-rouge">value</code>.</li> <li><code class="highlighter-rouge">/</code>: Return the host name.</li> </ul> <p>For example, if your site is hosted at <code class="highlighter-rouge">localhost:8000</code>, you can go to <code class="highlighter-rouge">localhost:8000/foo/bar</code> to set the value of the key <code class="highlighter-rouge">foo</code> to <code class="highlighter-rouge">bar</code> and then you can go to <code class="highlighter-rouge">localhost:8000/foo</code> to get the value of <code class="highlighter-rouge">foo</code>(in this case, <code class="highlighter-rouge">bar</code>). To check load balacing, all the endpoints returns the current host name.</p> <p>You can check out the code for this in the GitHub <a href="https://github.com/botleg/tutum-nodejs-redis">repo</a>. It is also built into a Docker image under <a href="https://hub.docker.com/r/hanzel/tutum-nodejs-redis/">hanzel/tutum-nodejs-redis</a>.</p> <p>To run this application, you need to set the following environment variables:</p> <ul> <li><code class="highlighter-rouge">APP_PORT</code>: Port to run the Node.js application.</li> <li><code class="highlighter-rouge">REDIS_IP</code>: The IP of the redis instance.</li> <li><code class="highlighter-rouge">REDIS_PORT</code>: The PORT of the redis instance.</li> </ul> <p>We are going to use HAProxy to do the load balancing. Tutum provides it’s own docker <a href="https://github.com/tutumcloud/haproxy">image</a> for HAProxy. If we deploy this image in Tutum and the link a service, it will configure itself based on the target number of containers of that linked service.</p> <h2 id="creating-a-node-clusters">Creating a Node clusters</h2> <p>Create an account with <a href="https://www.tutum.co/">Tutum</a>. Then connect it to your favourite cloud provider. Nodes are server instances or hosts, where we will be hosting the containers.</p> <p>Goto Nodes tab and click on the <code class="highlighter-rouge">Launch your first node</code> button. Give a name for the cluster. You can use <code class="highlighter-rouge">Deploy tags</code> to specify where you want the services to be hosted. For this article, it’s not needed. Now select your provider, region and instance type, as needed. I am selecting 1GB instance from Digital Ocean.</p> <p><img src="/assets/images/tutum-nodes@2x.jpg" srcset="/assets/images/tutum-nodes@1x.jpg 300w, /assets/images/tutum-nodes@2x.jpg 600w, /assets/images/tutum-nodes@3x.jpg 900w" sizes="(min-width: 960px) 900px, 100vw" alt="New node cluster settings" class="center-image" /> <em class="image-caption">New node cluster settings</em></p> <p>Now select the number of nodes you want in your cluster. I want two nodes in the cluster. You can change any time as needed. Now click the button <code class="highlighter-rouge">Launch node cluster</code> button to deploy the cluster. This could take a few minutes. Once it’s ready, we can see the status <code class="highlighter-rouge">Deployed</code> for each node.</p> <h2 id="stackfiles">Stackfiles</h2> <p>Each docker image running are called services here. We can add each services and configure it from the Tutum web UI with the <code class="highlighter-rouge">Services</code> tab. However, this is not the best way to do this.</p> <p>Tutum supports configuration files called <code class="highlighter-rouge">Stackfiles</code> and those files are named <code class="highlighter-rouge">tutum.yml</code>. This is very similar to <code class="highlighter-rouge">docker-compose.yml</code> with additional parameters for the deployment configuration. We can specify, configure and link services with this file.</p> <p>We will start with the redis service. The configuration required for this is given below:</p> <figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">redis</span>:
  <span class="n">image</span>: <span class="s1">'redis'</span>
  <span class="n">target_num_containers</span>: <span class="m">1</span>
  <span class="n">deployment_strategy</span>: <span class="n">high_availability</span>
  <span class="n">command</span>: <span class="n">redis</span>-<span class="n">server</span> --<span class="n">appendonly</span> <span class="n">yes</span>
  <span class="n">expose</span>:
    - <span class="s1">'6379'</span>
  <span class="n">volumes</span>:
    - /<span class="n">data</span></code></pre></figure> <p>The image used in <code class="highlighter-rouge">redis</code>. The next two parameters are for deployment purpose. The <code class="highlighter-rouge">target_num_containers</code> parameters is for scaling and it show how many instance of this containers that we need. We need only one instance of Redis. There are many deployment strategies available. The <code class="highlighter-rouge">high_availability</code> value ensures that the containers are deployment in such a way that it’s is always available. You can read more about these parameters in <a href="https://support.tutum.co/support/solutions/articles/5000583471-stack-yaml-reference">Stackfile docs</a>. We use the command <code class="highlighter-rouge">redis-server --appendonly yes</code> for persistance with Redis. We need to expose the port 6379 of Redis container to link it to other services. The final parameter <code class="highlighter-rouge">volumes</code>, save the data in <code class="highlighter-rouge">/data</code> folder for persistance.</p> <p>The configuration for Node.js application is given below:</p> <figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">node</span>:
  <span class="n">image</span>: <span class="s1">'hanzel/tutum-nodejs-redis'</span>
  <span class="n">target_num_containers</span>: <span class="m">4</span>
  <span class="n">deployment_strategy</span>: <span class="n">high_availability</span>
  <span class="n">links</span>:
    - <span class="n">redis</span>
  <span class="n">environment</span>:
    <span class="n">APP_PORT</span>: <span class="m">4000</span>
    <span class="n">REDIS_IP</span>: <span class="n">redis</span>
    <span class="n">REDIS_PORT</span>: <span class="m">6379</span>
  <span class="n">expose</span>:
    - <span class="s1">'4000'</span></code></pre></figure> <p>The images used here is <code class="highlighter-rouge">hanzel/tutum-nodejs-redis</code>. We are using the load balancing of this service. So we will have four instances of this container. Since we have used the <code class="highlighter-rouge">high_availability</code> deployment strategy, each of our two nodes will have two containers of this image each.</p> <p>We are linking the redis service to this service with the <code class="highlighter-rouge">links</code> paramter. This allows us to access the port 6379 of redis, which is the exposed port of redis service. We can also access the IP of redis service with <code class="highlighter-rouge">redis</code> keyword.</p> <p>Now, we need to set the environment variables. This application will run on the port defined in <code class="highlighter-rouge">APP_PORT</code> variable, 4000 in this case. The IP for redis instance is <code class="highlighter-rouge">redis</code> and the port is 6379. We now expose the port 4000 of this application.</p> <p>The final service that we use is for load balancing and the configuration for this is given below:</p> <figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">lb</span>:
  <span class="n">image</span>: <span class="s1">'tutum/haproxy:latest'</span>
  <span class="n">links</span>:
    - <span class="n">node</span>
  <span class="n">ports</span>:
    - <span class="s1">'80:80'</span>
  <span class="n">restart</span>: <span class="n">always</span>
  <span class="n">roles</span>:
    - <span class="n">global</span></code></pre></figure> <p>The image used here is <code class="highlighter-rouge">tutum/haproxy:latest</code> and we are linking the <code class="highlighter-rouge">node</code> service. With the <code class="highlighter-rouge">ports</code> parameter, we can set the ports that are publicly accessible. We are mapping the port <code class="highlighter-rouge">80</code> of the host device with port <code class="highlighter-rouge">80</code> of this container. We set the <code class="highlighter-rouge">restart</code> parameter to <code class="highlighter-rouge">always</code> so that this service will restarted everytime it stops. We also need to set the <code class="highlighter-rouge">roles</code> parameter to <code class="highlighter-rouge">global</code>. This allow this service to communicate with Tutum APIs and reconfigure based on your cluster.</p> <p>So the entire Stackfile will be this.</p> <figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">lb</span>:
  <span class="n">image</span>: <span class="s1">'tutum/haproxy:latest'</span>
  <span class="n">links</span>:
    - <span class="n">node</span>
  <span class="n">ports</span>:
    - <span class="s1">'80:80'</span>
  <span class="n">restart</span>: <span class="n">always</span>
  <span class="n">roles</span>:
    - <span class="n">global</span>

<span class="n">node</span>:
  <span class="n">image</span>: <span class="s1">'hanzel/tutum-nodejs-redis'</span>
  <span class="n">target_num_containers</span>: <span class="m">4</span>
  <span class="n">deployment_strategy</span>: <span class="n">high_availability</span>
  <span class="n">links</span>:
    - <span class="n">redis</span>
  <span class="n">environment</span>:
    <span class="n">APP_PORT</span>: <span class="m">4000</span>
    <span class="n">REDIS_IP</span>: <span class="n">redis</span>
    <span class="n">REDIS_PORT</span>: <span class="m">6379</span>
  <span class="n">expose</span>:
    - <span class="s1">'4000'</span>

<span class="n">redis</span>:
  <span class="n">image</span>: <span class="s1">'redis'</span>
  <span class="n">target_num_containers</span>: <span class="m">1</span>
  <span class="n">deployment_strategy</span>: <span class="n">high_availability</span>
  <span class="n">command</span>: <span class="n">redis</span>-<span class="n">server</span> --<span class="n">appendonly</span> <span class="n">yes</span>
  <span class="n">expose</span>:
    - <span class="s1">'6379'</span>
  <span class="n">volumes</span>:
    - /<span class="n">data</span></code></pre></figure> <h2 id="deploying-the-stack">Deploying the Stack</h2> <p>To deploy this stack, goto the <code class="highlighter-rouge">Stacks</code> tab in Tutum and click the <code class="highlighter-rouge">Create stack</code> button. Now give a name for this stack and paste <a href="https://stackfiles.io/registry/56a37bc035a28a01009e57ed">the Stackfile</a>. Now, click <code class="highlighter-rouge">Create and deploy</code>. This will deploy all the services. This can also take a few minutes.</p> <p>Once the stack is running, goto <code class="highlighter-rouge">Endpoints</code> tab in the stack. This will have all publicly accessible ports of any service. We have only one, the port 80 in load balancer service. A <code class="highlighter-rouge">tutum.io</code> subdomain will be created for this. Open this link to access your stack.</p> <p>You can see the hostname in the page. Try reloading this page and we can see that the hostname is changing. This shows that out load balancing is working.</p> <h2 id="tldr">TL;DR</h2> <p>In this article, we deployed a load balanced Node.js application and Redis database with Docker containers with <a href="https://www.tutum.co/">Tutum</a>. We have seen that, Tutum provides us with easy access to powerful features like load balancing and scaling when using Docker hosting.</p> <p class="post-meta">Tags: tutum, docker, container, haproxy, node.js, redis, scale, load, balance, deploy, popular, and devops </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/hello-world/>hello world :)</a><br/><a href=/stories/generators-in-javascript-and-python/>Generators in JavaScript and Python</a><br/><a href=/stories/https-with-lets-encrypt-and-nginx/>HTTPS with Let's Encrypt and nginx</a><br/><a href=/stories/line-numbers-in-jekyll-code-blocks/>Line numbers in Jekyll code blocks</a><br/><a href=/stories/bookmarklet-scripts/>Bookmarklet Scripts</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading">Botleg</h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> <li> <a href="https://github.com/botleg"><span class="username">botleg </span> <span class="icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/> </svg> </span> </a> </li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li><a href="https://github.com/hanzeljesheen"><span class="username">github</span></a></li> <li><a href="https://bitbucket.org/hanzel"><span class="username">bitbucket</span></a></li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, big data analysis, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <style type="text/css">body,h1,h2{font-weight:300}.wrapper:after{clear:both}html{box-sizing:border-box}*,::after,::before{box-sizing:inherit}body{background-color:#fdfdfd;color:#111;font-family:Helvetica,Arial,sans-serif;font-size:18px;line-height:1.6;text-size-adjust:100%}h1,h2,p,ul{margin-bottom:10px}.wrapper section{margin-top:30px}ul{margin-left:20px}a{color:#2a7ae2;text-decoration:none}.site-header{min-height:60px;position:relative}.site-title{margin-bottom:0;float:left;font-size:28px;line-height:60px;text-transform:lowercase;color:#424242}#search{padding:10px 15px 10px 0}#search #searchbox{background:#828282;border:0;color:#fdfdfd;float:right;font-size:1em;height:40px;line-height:40px;max-width:150px;padding:5px 10px 5px 30px}.page-content{padding:0 0 20px}.post-meta{color:#828282;display:inline-block;font-size:15.75px}.post-header{-webkit-box-align:center;-moz-box-align:center;-ms-box-align:center;box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-moz-box-pack:center;-webkit-justify-content:center;justify-content:center;color:#fdfdfd;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-align:center;-ms-flex-pack:center;height:300px;margin-bottom:10px}.post-header .header-content{text-align:center;max-width:600px}.icon{background-position:10px center;background-repeat:no-repeat;background-size:30px;padding:0 30px 0 45px}.icon span{color:#fdfdfd;display:none}@media screen and (min-width:400px){.icon span{display:inline}}.post-title{color:#e8e8e8;font-size:36px}.page-content,.post-content{margin-bottom:20px}.page-content h2,.post-content h2{font-size:32px}</style> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v205'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script async type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
