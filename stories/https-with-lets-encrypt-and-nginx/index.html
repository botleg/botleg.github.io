<!DOCTYPE html> <html> <head> <title>HTTPS with Let's Encrypt and nginx</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="HTTPS is a secure protocol for the internet. Unlike the communication in HTTP, which happens in plain-text, the data transferred between the server and the c..."> <meta name="author" content="Hanzel Jesheen"> <meta itemprop="name" content="HTTPS with Let's Encrypt and nginx"> <meta itemprop="description" content="HTTPS is a secure protocol for the internet. Unlike the communication in HTTP, which happens in plain-text, the data transferred between the server and the c..."> <link rel="canonical" href="https://botleg.com/stories/https-with-lets-encrypt-and-nginx/"> <link rel="alternate" type="application/rss+xml" title="Botleg" href="https://botleg.com/feed" /> </head> <body> <header class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </header> <div class="page-content"> <div class="post"> <header class="post-header" style="background:rgb(241, 196, 15) 25%;background-image: linear-gradient(90deg, rgb(241, 196, 15) 25%, rgb(231, 76, 60) 100%);background-image: -moz-linear-gradient(left, rgb(241, 196, 15) 25%, rgb(231, 76, 60) 100%);background-image: -webkit-linear-gradient(left, rgb(241, 196, 15) 25%, rgb(231, 76, 60) 100%);background-image: -o-linear-gradient(left, rgb(241, 196, 15) 25%, rgb(231, 76, 60) 100%);background-image: -ms-linear-gradient(left, rgb(241, 196, 15) 25%, rgb(231, 76, 60) 100%);"> <div class="header-content"> <h1 class="post-title">HTTPS with Let's Encrypt and nginx</h1> </div> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Jan 17, 2016 | <a href="/categories/devops">devops</a> </p> <p>HTTPS is a secure protocol for the internet. Unlike the communication in HTTP, which happens in plain-text, the data transferred between the server and the client with HTTPS is encrypted. HTTPS also verifies the identity of the website we are accessing with a <code class="highlighter-rouge">SSL/TLS</code> certificate. It was initially used in online payment website, but in the recent age of privacy, it is deemed mandatory. That’s where <a href="https://letsencrypt.org/">Let’s Encrypt</a> comes in.</p> <p>Let’s Encrypt is a <code class="highlighter-rouge">Certificate Authority</code>, they verify a website and issues certificates. The browsers have a list of trusted Certificate Authorities whose certificates it will accept. There are a lot of Certificate Authorities, so what make Let’s Encrypt different?</p> <p>Two main issues with SSL certificates was that, it was paid and the process is not generally automated. Let’s Encrypt solves both these issues. Let’s Encrypt issues certificates <code class="highlighter-rouge">free of cost</code> and it can be automated. You just need root terminal access to the server. It is currently in public beta and is backed by major players like Mozilla, Facebook, Google, etc.</p> <p>In this article, we will see how to create a certificate with Let’s Encrypt and use it to host our server via HTTPS. We will be using an <code class="highlighter-rouge">nginx</code> server here but the process is similar to all servers.</p> <h2 id="installing-lets-encrypt">Installing Let’s Encrypt</h2> <p>Use SSH to log into your server as <code class="highlighter-rouge">root</code> user. If you have <code class="highlighter-rouge">git</code> installed in the server, you can clone the Let’s Encrypt repo in <code class="highlighter-rouge">/opt</code> folder.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /opt
git clone https://github.com/letsencrypt/letsencrypt</code></pre></figure> <p>Otherwise, download the latest <code class="highlighter-rouge">tar.gz</code> package from <code class="highlighter-rouge">https://github.com/letsencrypt/letsencrypt/releases</code> with wget. Extract this to <code class="highlighter-rouge">/opt/</code> and rename the folder to <code class="highlighter-rouge">letsencrypt</code>. Latest version at the time of writing was <code class="highlighter-rouge">v0.2.0</code>, so the commands for this are.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">wget https://github.com/letsencrypt/letsencrypt/archive/v0.2.0.tar.gz
tar xf v0.2.0.tar.gz -C /opt/
<span class="nb">cd</span> /opt
mv letsencrypt-0.2.0 letsencrypt</code></pre></figure> <p>Now we have letsencrypt installed at <code class="highlighter-rouge">/opt/letsencrypt</code>. You can add this to <code class="highlighter-rouge">PATH</code>.</p> <h2 id="lets-encrypt-configuration">Let’s Encrypt Configuration</h2> <p>Before you add SSL certificates, you need to register a domain and the domain must point to the server’s public address. For this, you need to a set up a <code class="highlighter-rouge">A</code> or <code class="highlighter-rouge">CNAME</code> record with your DNS. You can check with your domain registar or custom DNS service to do this. If you have a HTTP site running in the server, you would have already done this.</p> <p>Let’s Encrypt need to verify that you own the domain before they provide you with the certificates. This can be done in various ways. If you are running <code class="highlighter-rouge">Apache</code> server, Let’s Encrypt can use it to verify your ownership and even install the certificates in the server for you. There is also something similar for <code class="highlighter-rouge">nginx</code>, but it’s still experimental and not production-ready.</p> <p>Another method is <code class="highlighter-rouge">standalone</code>, where the Let’s Encrypt client will create a temporary webserver for verification. However, this need our <code class="highlighter-rouge">nginx</code> server to be shutdown while creating and renewing our certificates. That’s just not viable.</p> <p>So we will go with the <code class="highlighter-rouge">webroot</code> method. In this method, we provide a folder path as <code class="highlighter-rouge">webroot-path</code>. This folder must be served by our server. A temporary file will be made inside <code class="highlighter-rouge">&lt;webroot-path&gt;/.well-known/acme-challenge/</code> by the client. Let’s Encrypt will access it from the domain to verify the ownership.</p> <p>For example, if the domain in <code class="highlighter-rouge">www.example.com</code> and the <code class="highlighter-rouge">webroot-path</code> is <code class="highlighter-rouge">/usr/share/nginx/html</code>. The client will create a temporary file named something like <code class="highlighter-rouge">1PnCIkY</code> inside <code class="highlighter-rouge">/usr/share/nginx/html/.well-known/acme-challenge/</code> and it will accessed from <code class="highlighter-rouge">www.example.com/.well-known/acme-challenge/1PnCIkY</code> for verification of the domain ownership.</p> <p>The configuration needed to create the certificates are put in a file named <code class="highlighter-rouge">cli.ini</code> inside <code class="highlighter-rouge">/opt/letsencrypt</code>.</p> <figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">rsa</span>-<span class="n">key</span>-<span class="n">size</span> = <span class="m">4096</span>
<span class="n">email</span> = &lt;<span class="n">your</span>-<span class="n">email</span>&gt;
<span class="n">domains</span> = &lt;<span class="n">domains</span>&gt;
<span class="n">authenticator</span> = <span class="n">webroot</span>
<span class="n">webroot</span>-<span class="n">path</span> = /<span class="n">usr</span>/<span class="n">share</span>/<span class="n">nginx</span>/<span class="n">html</span></code></pre></figure> <p>You need to provide your email address for recovering the certificate credentials. Also add the domains for which you want the certificates for seperated by commas like, <code class="highlighter-rouge">example.com, www.example.com</code>.</p> <h2 id="nginx">Nginx</h2> <p>We need to set up nginx to serve the <code class="highlighter-rouge">webroot-path</code> folder with nginx. If you have not installed <code class="highlighter-rouge">nginx</code> yet, install it with,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">apt-get install nginx</code></pre></figure> <p>Now, open the nginx configuration at <code class="highlighter-rouge">/etc/nginx/sites-available/default</code> and change it as following to serve <code class="highlighter-rouge">.well-known</code> folder.</p> <figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
  <span class="kn">server_name</span> <span class="s">&lt;domain-name&gt;</span><span class="p">;</span>
  
  <span class="kn">root</span> <span class="n">/usr/share/nginx/html</span><span class="p">;</span>
  <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.nginx-debian.html</span><span class="p">;</span>

  <span class="kn">location</span> <span class="s">^~</span> <span class="n">/.well-known/</span> <span class="p">{</span>
    <span class="kn">allow</span> <span class="s">all</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <h2 id="create-certificate">Create Certificate</h2> <p>Finally, we are ready to create our first certificate. Execute the following commands.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /opt/letsencrypt
./letsencrypt-auto certonly --agree-tos --config cli.ini</code></pre></figure> <p>The <code class="highlighter-rouge">certonly</code> parameter creates the certificate. <code class="highlighter-rouge">--agree-tos</code> flag is used say that we are accepting the terms. <code class="highlighter-rouge">--config</code> flag is used to point to the configuration file, which is found in <code class="highlighter-rouge">/opt/letsencrypt/cli.ini</code>.</p> <p>This creates the SSL certificates in <code class="highlighter-rouge">/etc/letsencrypt/live/&lt;domain-name&gt;/</code> folder. Whenever we renew the certificates, the latest will be found in this folder.</p> <h2 id="nginx-https-configuration">Nginx HTTPS configuration</h2> <p>Now that we have the certificates, we can change the configuration in nginx to serve via HTTPS. The HTTPS connection is done via the port <code class="highlighter-rouge">443</code>. The first server block in nginx configuration at <code class="highlighter-rouge">/etc/nginx/sites-available/default</code> is to redirect the HTTP traffic to HTTPS. We are also returning a <code class="highlighter-rouge">301 Moved Permanently</code> header back. Replace the <code class="highlighter-rouge">domain-name</code> here to your domain.</p> <figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
  <span class="kn">server_name</span> <span class="s">&lt;domain-name&gt;</span><span class="p">;</span>
  <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p>The second server block is for HTTPS running at port 443. It uses the certificates found at <code class="highlighter-rouge">/etc/letsencrypt/live/&lt;domain-name&gt;</code></p> <figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
  <span class="kn">server_name</span> <span class="s">&lt;domain-name&gt;</span><span class="p">;</span>

  <span class="kn">ssl_certificate</span> <span class="n">/etc/letsencrypt/live/&lt;domain-name&gt;/fullchain.pem</span><span class="p">;</span>
  <span class="kn">ssl_certificate_key</span> <span class="n">/etc/letsencrypt/live/&lt;domain-name&gt;/privkey.pem</span><span class="p">;</span>

  <span class="kn">root</span> <span class="n">/usr/share/nginx/html</span><span class="p">;</span>
  <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.nginx-debian.html</span><span class="p">;</span>

  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kn">location</span> <span class="s">^~</span> <span class="n">/.well-known/</span> <span class="p">{</span>
    <span class="kn">allow</span> <span class="s">all</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>You can reload the nginx with,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">service nginx reload</code></pre></figure> <p>If your are using reverse-proxy to host in some other port, the configuration will look like this.</p> <figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">4125</span><span class="p">;</span>
  <span class="kn">server_name</span> <span class="s">&lt;domain-name&gt;</span><span class="p">;</span>

  <span class="kn">error_page</span> <span class="mi">497</span> <span class="s">https://</span><span class="nv">$host</span><span class="p">:</span><span class="mi">4125</span><span class="nv">$request_uri</span><span class="p">;</span>

  <span class="kn">ssl</span> <span class="no">on</span><span class="p">;</span>
  <span class="kn">ssl_certificate</span> <span class="n">/etc/letsencrypt/live/&lt;domain-name&gt;/fullchain.pem</span><span class="p">;</span>
  <span class="kn">ssl_certificate_key</span> <span class="n">/etc/letsencrypt/live/&lt;domain-name&gt;/privkey.pem</span><span class="p">;</span>

  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span>          <span class="s">http://127.0.0.1:4125/</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span>    <span class="s">X-Real-IP</span>         <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span>    <span class="s">X-Forwarded-For</span>   <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span>    <span class="s">X_FORWARDED_PROTO</span> <span class="s">https</span><span class="p">;</span>
    <span class="kn">proxy_set_header</span>    <span class="s">Host</span>              <span class="nv">$http_host</span><span class="p">;</span>
    <span class="kn">proxy_buffering</span>     <span class="no">off</span><span class="p">;</span>
    <span class="kn">proxy_redirect</span>      <span class="no">off</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>Here, the <code class="highlighter-rouge">error_page 497</code> is used to redirect the HTTP traffic to port <code class="highlighter-rouge">4125</code> to HTTPS.</p> <h2 id="automated-renewal">Automated Renewal</h2> <p>Let’s Encrypt certificates are only valid for 90 days, so you would have to renew them. To renew, you just have to run the client with <code class="highlighter-rouge">--renew-by-default</code> flag also. The command would look like this.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">/opt/letsencrypt/letsencrypt-auto certonly --renew-by-default --agree-tos --config /opt/letsencrypt/cli.ini</code></pre></figure> <p>This command will renew the certificate. We can automate renewal by running this command as a <code class="highlighter-rouge">cron</code> job. Cron is a time-based job scheduler. We can make this command run once a month to renew certificates at a monthly basis to prevent it from being expired. We also need to reload the nginx configurations.</p> <p>To add a new cron job, type the following command.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo crontab -e</code></pre></figure> <p>Add the following lines to the end of the cron file.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
<span class="nv">HOME</span><span class="o">=</span>/
<span class="nv">MAILTO</span><span class="o">=</span>”example@mail.com”
30 4 1 <span class="k">*</span> <span class="k">*</span> <span class="o">(</span>/opt/letsencrypt/letsencrypt-auto certonly --renew-by-default --agree-tos --config /opt/letsencrypt/cli.ini <span class="o">&amp;&amp;</span> service nginx reload<span class="o">)</span> &gt;&gt; /var/log/letsencrypt.log</code></pre></figure> <p>This causes the command to run every month on the 1st at 4:30AM. The output of this command is stored in <code class="highlighter-rouge">/var/log/letsencrypt.log</code>.</p> <p>As a side note, there are some limits on the number of certificates we can make a week for a single domain. So to try these command with no limits, you can add the flag <code class="highlighter-rouge">--server https://acme-staging.api.letsencrypt.org/directory</code> to Let’s Encrypt commands. This creates dummy certificates, which are NOT valid but you can use it to test the working of the cron job.</p> <p class="post-meta">Tags: https, letsencrypt, ssl, tls, certificate, authority, nginx, git, popular, and devops </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/hello-world/>hello world :)</a><br/><a href=/stories/generators-in-javascript-and-python/>Generators in JavaScript and Python</a><br/><a href=/stories/orchestrate-docker-containers-with-tutum/>Orchestrate Docker containers with Tutum</a><br/><a href=/stories/line-numbers-in-jekyll-code-blocks/>Line numbers in Jekyll code blocks</a><br/><a href=/stories/bookmarklet-scripts/>Bookmarklet Scripts</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading">Botleg</h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> <li> <a href="https://github.com/botleg"><span class="username">botleg </span> <span class="icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/> </svg> </span> </a> </li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li><a href="https://github.com/hanzeljesheen"><span class="username">github</span></a></li> <li><a href="https://bitbucket.org/hanzel"><span class="username">bitbucket</span></a></li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, big data analysis, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v205'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
