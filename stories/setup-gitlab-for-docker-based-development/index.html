<!DOCTYPE html> <html> <head> <title>Setup Gitlab for Docker based development - botleg</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Gitlab is known as the open-source git repository manager. However, Gitlab does a lot more than that right now. It features a really powerful CI/CD engine an..."> <meta name="author" content="Hanzel Jesheen"> <meta name="twitter:card" content="Gitlab is an open-source git repository manager. We will deploy Gitlab for docker based projects. We will also configure Gitlab Continuous Integration and Container Registry and secure this setup with HTTPS." /> <meta name="twitter:site" content="@HanzelJesheen" /> <meta name="twitter:creator" content="@HanzelJesheen" /> <meta property="og:url" content="https://botleg.com/stories/setup-gitlab-for-docker-based-development/" /> <meta property="og:type" content="article" /> <meta property="og:title" content="Setup Gitlab for Docker based development" /> <meta property="og:description" content="Gitlab is an open-source git repository manager. We will deploy Gitlab for docker based projects. We will also configure Gitlab Continuous Integration and Container Registry and secure this setup with HTTPS." /> <meta property="og:image" content="" /> <meta property="og:site_name" content="botleg" /> <meta property="article:author" content="Hanzel Jesheen" /> <meta itemprop="name" content="Setup Gitlab for Docker based development"> <meta itemprop="description" content="Gitlab is known as the open-source git repository manager. However, Gitlab does a lot more than that right now. It features a really powerful CI/CD engine an..."> <link rel="canonical" href="https://botleg.com/stories/setup-gitlab-for-docker-based-development/"> <link rel="alternate" type="application/rss+xml" title="botleg" href="https://botleg.com/feed" /> </head> <body> <div class="page-content"> <div class="post"> <header style="background:rgb(28, 120, 185);background-image:linear-gradient(160deg, rgb(28, 120, 185), rgb(104, 104, 176));background-image:-moz-linear-gradient(160deg, rgb(28, 120, 185), rgb(104, 104, 176));background-image:-webkit-linear-gradient(160deg, rgb(28, 120, 185), rgb(104, 104, 176));background-image:-o-linear-gradient(160deg, rgb(28, 120, 185), rgb(104, 104, 176));background-image:-ms-linear-gradient(160deg, rgb(28, 120, 185), rgb(104, 104, 176)); "> <section class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <a href="/feed/index.xml"><span class="rss-icon"> <svg viewBox="0 0 24 24" width="30px" height="30px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg></span> </a> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </section> <section class="post-header"> <div class="header-content"> <h1 class="post-title">Setup Gitlab for Docker based development</h1> <a class="icon gh" href="https://github.com/botleg/gitlab-nginx" target="blank"><span>View Code</span></a> </div> </section> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Feb 1, 2017 | <a href="/categories/cloud">cloud</a> </p> <p><a href="https://about.gitlab.com/">Gitlab</a> is known as the open-source git repository manager. However, Gitlab does a lot more than that right now. It features a really powerful CI/CD engine and even packs a docker registry. It has become an essential part of my development process. In this article, we will discuss setting up Gitlab for docker based developments.</p> <p>We will start by setting up a VM in the cloud and installing Gitlab there. We will configure it to support HTTPS. We will also setup <a href="https://about.gitlab.com/gitlab-ci/">Gitlab CI</a>, the Continuous integration solution that comes with Gitlab with multiple runners to run the builds in parallel. We will also setup the docker registry to store our docker images and secure it with HTTPs. Finally we will test this setup with docker based project.</p> <p>For the cloud VM, I’m using <a href="https://www.digitalocean.com/">Digital Ocean</a>, but the process is similar for other vendors as well. We will use <a href="https://letsencrypt.org/">Let’s Encrypt</a> for generating SSL certificates. To use this, you would also need a domain. The project used to test the gitlab setup is hosted <a href="https://github.com/botleg/gitlab-nginx">here</a>. It is simple project that build a docker image with <a href="https://www.nginx.com/">nginx</a> webserver.</p> <h2 id="create-the-vm">Create the VM</h2> <p>Create a VM using your cloud service, I am using Digital Ocean. You may also host Gitlab in your local system. I am choosing <code class="highlighter-rouge">Ubuntu 16.04 x64</code> as the OS, but any linux distro will work fine. Also, since we are putting the entire setup in one VM, make it with atleast 8GB of RAM.</p> <p>We will register this Gitlab instance with a subdomain. Example: <code class="highlighter-rouge">gitlab.botleg.com</code>. Once you have created your created your VM, create a new <code class="highlighter-rouge">A</code> record in your DNS provider. The name will be subdomain name, <code class="highlighter-rouge">gitlab</code> here and provide the public IP of the VM. SSH into the VM created and create a new user. Follow <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04">this</a> tutorial to add this user and setup password-less access.</p> <h2 id="installing-gitlab">Installing Gitlab</h2> <p>We will be using the Community Edition of Gitlab. All the features that we need in our development process is supported in this edition. A comparison of the editions can be found <a href="https://about.gitlab.com/products/#compare-options">here</a>. Easiest way to install Gitlab is to use the Omnibus package. It contains everything required for Gitlab in a single package with <a href="https://www.chef.io/">Chef</a> recipes for the tasks.</p> <p>Just follow the steps in <a href="https://about.gitlab.com/downloads/#ubuntu1604">this</a> site to install it. You just have to install some dependencies, add the new repository and install the <code class="highlighter-rouge">gitlab-ce</code> package. The command <code class="highlighter-rouge">sudo gitlab-ctl reconfigure</code> triggers a chef receipe that reconfigures Gitlab based on the changes made to the configuration files.</p> <p>Once this is done, you will able to go to the domain setup in DNS service and see Gitlab login page. You will be asked to set password for the default admin account named <code class="highlighter-rouge">root</code>. Set the admin password and login to Gitlab. Now, I recommend that you create a new admin user and use it for the next steps. This can be done from the Admin Area.</p> <h2 id="enabling-https">Enabling HTTPS</h2> <p>To enable HTTPS for Gitlab, we need to have a certificate generated for this domain. We will use <code class="highlighter-rouge">Let's Encrypt</code> for this. To know more about this, visit <a href="https://letsencrypt.org/getting-started/">here</a>. We will start by installing <code class="highlighter-rouge">Let's Encrypt</code> with,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install letsencrypt</code></pre></figure> <p>To create the certificate, we need to verify that we indeed own the domain. To do this, <code class="highlighter-rouge">letencrypt</code> tool provide a plugin <code class="highlighter-rouge">standalone</code> that creates a temporary web server and verifies the domain. So, for this to work, we need to temporarily disable gitlab. To do this, use the following commands and enter the domain name and email when prompted</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo gitlab-ctl stop
sudo letsencrypt certonly --standalone --agree-tos
sudo gitlab-ctl start</code></pre></figure> <p>The certificates generated will be in the folder <code class="highlighter-rouge">/etc/letsencrypt/live/&lt;domain name&gt;/</code>. The certificate file is <code class="highlighter-rouge">fullchain.pem</code> and the key is <code class="highlighter-rouge">privkey.pem</code>. We need to change this is in the Gitlab configurations. This file is located at <code class="highlighter-rouge">/etc/gitlab/gitlab.rb</code>. This file is full of comments. We will make a backup of this file and clear it,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo cp /etc/gitlab/gitlab.rb /etc/gitlab/gitlab.rb.bak
sudo truncate -s 0 /etc/gitlab/gitlab.rb</code></pre></figure> <p>We need to add the following configuration items:</p> <ul> <li><code class="highlighter-rouge">external_url</code>: The URL where gitlab can be accessed. It will contain <code class="highlighter-rouge">https://</code> followed by the domain name.</li> <li><code class="highlighter-rouge">nginx['redirect_http_to_https']</code>: We set it to <code class="highlighter-rouge">true</code> to redirect all HTTP traffic to HTTPS.</li> <li><code class="highlighter-rouge">nginx['ssl_certificate']</code>: The location of the certificate file.</li> <li><code class="highlighter-rouge">nginx['ssl_certificate_key']</code>: The location of the certificate key.</li> </ul> <p>Open the file <code class="highlighter-rouge">/etc/gitlab/gitlab.rb</code> as root and enter the following lines.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">external_url</span> <span class="s1">'https://&lt;domain name&gt;'</span>
<span class="n">nginx</span><span class="p">[</span><span class="s1">'redirect_http_to_https'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>

<span class="n">nginx</span><span class="p">[</span><span class="s1">'ssl_certificate'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/etc/letsencrypt/live/&lt;domain name&gt;/fullchain.pem"</span>
<span class="n">nginx</span><span class="p">[</span><span class="s1">'ssl_certificate_key'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/etc/letsencrypt/live/&lt;domain name&gt;/privkey.pem"</span></code></pre></figure> <p>Replace <code class="highlighter-rouge">&lt;domain name&gt;</code> with the domain name registered for Gitlab. Reconfigure Gitlab with new settings with the command,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo gitlab-ctl reconfigure</code></pre></figure> <p>Now, when we go the Gitlab site, it will be in HTTPS with the <code class="highlighter-rouge">Let's Encrypt</code> certificate.</p> <h2 id="gitlab-ci-runners">Gitlab CI Runners</h2> <p>In this step, we will setup the runners needed to run the builds for CI/CD. The runners will build, test and publish the projects as defined by the <code class="highlighter-rouge">.gitlab-ci.yml</code> file. We will discuss more about this later. Since we are doing docker based projects, we will use docker images for runners and use <code class="highlighter-rouge">Docker inside Docker</code> for running our builds.</p> <p>The first step for this would be to actually install docker engine in this server,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl -sSL https://get.docker.com/ | sh
sudo usermod -aG docker <span class="nv">$USER</span></code></pre></figure> <p>The second command is to access docker without <code class="highlighter-rouge">sudo</code>. You might need to logout and login again to do this.Once we have the docker engine installed, we will run the <a href="https://hub.docker.com/r/gitlab/gitlab-runner/">Gitlab CI Multi Runner</a> image. We will set the image to always restart if it goes down. With this implementation, we will share the docker engine in the server with the runner. For this, we will create a volume at the location, <code class="highlighter-rouge">/var/run/docker.sock</code>. To do all this, use the following command,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker run -d --name runner1 --restart always -v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:latest</code></pre></figure> <p>Here, <code class="highlighter-rouge">runner1</code> is the name of this runner. You can run multiple runners to run the builds in parallel. To run more runners, run the previous command by changing the name <code class="highlighter-rouge">runner1</code> to something else. Example: <code class="highlighter-rouge">docker run -d --name runner2 --restart always -v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:latest</code>, and so on.</p> <p>To register these runners to Gitlab service, you need to have the registration token. You can find it in the <code class="highlighter-rouge">Runners</code> section of the Admin Area. Once you find this, run the following command,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker <span class="nb">exec</span> -it runner1 gitlab-runner register</code></pre></figure> <p>This command will ask the following things:</p> <ul> <li><code class="highlighter-rouge">gitlab-ci coordinator URL</code>: It is the domain name of the gitlab service with <code class="highlighter-rouge">https://</code>, Example: <code class="highlighter-rouge">https://gitlab.botleg.com</code>.</li> <li><code class="highlighter-rouge">gitlab-ci token</code>: Enter the registration token that we got from Gitlab site.</li> <li><code class="highlighter-rouge">description</code>: Give a name from this runner. Example: <code class="highlighter-rouge">runner1</code>.</li> <li><code class="highlighter-rouge">tags</code>: Give some tags to target this runner. Gitlab provide the option to run the tests on runner with certain tags.</li> <li><code class="highlighter-rouge">run untagged builds</code>: Boolean value that tell whether this runner can accept jobs without tags. Since we have only one type of runners here, we can provide <code class="highlighter-rouge">true</code> for this.</li> <li><code class="highlighter-rouge">executor</code>: How the jobs are executed by the runner. Here, we choose <code class="highlighter-rouge">docker</code>. To more about the other executors, check <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/executors/README.md">here</a>.</li> <li><code class="highlighter-rouge">default Docker image</code>: The docker image to run the tests in. We will user <code class="highlighter-rouge">docker:git</code> for this. This image allows for <code class="highlighter-rouge">docker in docker</code> and also has git inbuilt.</li> </ul> <p>Repeat this command for all your runners by changing the runner name. Example: <code class="highlighter-rouge">docker exec -it runner2 gitlab-runner register</code>. After you do this, you will be able to see these runners in the <code class="highlighter-rouge">Runners</code> section of Gitlab’s Admin Area.</p> <p>There is however one more step we need to do. We are sharing the docker engine in the server to the runners. These runners will create <code class="highlighter-rouge">docker:git</code> image to run the jobs. These jobs build and push docker images. We will use the docker engine from the server to do this. So, we need to make a docker volume of <code class="highlighter-rouge">/var/run/docker.sock</code> for the <code class="highlighter-rouge">docker:git</code> images created by the runners to share the docker engine. To do this, we need to modify the configuration of each runner. Run the following command to open up the configuration file of the runner.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker <span class="nb">exec</span> -it runner1 nano /etc/gitlab-runner/config.toml</code></pre></figure> <p>Edit the line <code class="highlighter-rouge">volumes = ["/cache"]</code> to <code class="highlighter-rouge">volumes = ["/cache", "/var/run/docker.sock:/var/run/docker.sock"]</code>. The file will look something like this:</p> <figure class="highlight"><pre><code class="language-toml" data-lang="toml"><span class="py">concurrent</span> <span class="p">=</span> <span class="mi">1</span>
<span class="py">check_interval</span> <span class="p">=</span> <span class="mi">0</span>

<span class="nn">[[runners]]</span>
  <span class="py">name</span> <span class="p">=</span> <span class="s">"runner1"</span>
  <span class="py">url</span> <span class="p">=</span> <span class="s">"https://gitlab.botleg.com"</span>
  <span class="py">token</span> <span class="p">=</span> <span class="s">"9ab32be14c9d2cb67fbec7aa59304f"</span>
  <span class="py">executor</span> <span class="p">=</span> <span class="s">"docker"</span>
  <span class="nn">[runners.docker]</span>
    <span class="py">tls_verify</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="py">image</span> <span class="p">=</span> <span class="s">"docker:git"</span>
    <span class="py">privileged</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="py">disable_cache</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="py">volumes</span> <span class="p">=</span> <span class="p">[</span><span class="s">"/cache"</span><span class="p">,</span> <span class="s">"/var/run/docker.sock:/var/run/docker.sock"</span><span class="p">]</span>
  <span class="nn">[runners.cache]</span></code></pre></figure> <p>Repeat this step for other runners as well.</p> <h2 id="container-registry">Container Registry</h2> <p>The final thing we need to setup is the <a href="https://docs.gitlab.com/ce/user/project/container_registry.html">Container Registry</a>. We will create a new sub-domain for registry, like <code class="highlighter-rouge">registry.botleg.com</code> and secure it using HTTPS. So, first thing would be to create a new <code class="highlighter-rouge">A</code> record with the DNS service. In this case, the name will be <code class="highlighter-rouge">registry</code> and give the public IP of the VM. Now, our server has <code class="highlighter-rouge">nginx</code> webserver. If the request is for <code class="highlighter-rouge">gitlab</code> subdomain, it will redirect to gitlab and if the request is for <code class="highlighter-rouge">registry</code>, it will redirect to registry.</p> <p>We also need to create new SSL certificate for this <code class="highlighter-rouge">registry</code> sub-domain. As before, we use Let’s Encrypt for this.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo gitlab-ctl stop
sudo letsencrypt certonly --standalone --agree-tos
sudo gitlab-ctl start</code></pre></figure> <p>Provide the domain for the registry when prompted. This will create the new SSL certificates, which can be found in the <code class="highlighter-rouge">/etc/letsencrypt/live</code> folder. Update the gitlab configuration file <code class="highlighter-rouge">/etc/gitlab/gitlab.rb</code> to add the following lines.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">registry_external_url</span> <span class="s1">'https://&lt;domain name&gt;'</span>
<span class="n">registry_nginx</span><span class="p">[</span><span class="s1">'ssl_certificate'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/etc/letsencrypt/live/&lt;domain name&gt;/fullchain.pem"</span>
<span class="n">registry_nginx</span><span class="p">[</span><span class="s1">'ssl_certificate_key'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/etc/letsencrypt/live/&lt;domain name&gt;/privkey.pem"</span></code></pre></figure> <p>Replace <code class="highlighter-rouge">&lt;domain name&gt;</code> with the domain registered for the registry. This will enable registry with HTTPS enabled. To update the changes, use the <code class="highlighter-rouge">sudo gitlab-ctl reconfigure</code> command. In the Admin area you can see that the Container Registry is enabled. To test this out, try logging into the registry.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">docker</span> <span class="n">login</span> <span class="o">&lt;</span><span class="n">registry</span> <span class="n">domain</span><span class="o">&gt;</span></code></pre></figure> <p>Replace <code class="highlighter-rouge">&lt;registry domain&gt;</code> with the domain registered for the registry and provide the Gitlab username and password. You can see the <code class="highlighter-rouge">Login Succeeded</code> message.</p> <h2 id="testing-setup">Testing Setup</h2> <p>We have now setup the Gitlab for the docker based development. To test this implementation, we will push a git repository to Gitlab and see the working of Gitlab CI and Container Registry. I have made a simple docker based project which can be found <a href="https://github.com/botleg/gitlab-nginx">here</a>. This just contains a <code class="highlighter-rouge">Dockerfile</code> that installs <code class="highlighter-rouge">nginx</code> websever, which serves the <code class="highlighter-rouge">index.html</code> file.</p> <p>The file that we are interested about is <code class="highlighter-rouge">.gitlab-ci.yml</code>. This contains all the information on how to build and deploy this project. To know more about this file, check <a href="https://docs.gitlab.com/ce/ci/yaml/">here</a>. The file for this project looks like this.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">image: </span><span class="n">docker</span><span class="ss">:git</span>

<span class="ss">stages:
</span><span class="o">-</span> <span class="n">build</span>
<span class="o">-</span> <span class="n">publish</span>

<span class="ss">build:
  stage: </span><span class="n">build</span>
  <span class="ss">script:
    </span><span class="o">-</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="vg">$REGISTRY_HOST</span><span class="o">/</span><span class="vg">$IMAGE_NAME</span> <span class="p">.</span>

<span class="nf">registry</span><span class="p">:</span>
  <span class="ss">stage: </span><span class="n">publish</span>
  <span class="ss">script:
    </span><span class="o">-</span> <span class="n">docker</span> <span class="n">login</span> <span class="o">-</span><span class="n">u</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span><span class="o">-</span><span class="n">token</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$CI_BUILD_TOKEN</span> <span class="vg">$REGISTRY_HOST</span>
    <span class="o">-</span> <span class="n">docker</span> <span class="n">push</span> <span class="vg">$REGISTRY_HOST</span><span class="o">/</span><span class="vg">$IMAGE_NAME</span></code></pre></figure> <p>Since the job is docker based, we will specify the image to run this test on. The image, <code class="highlighter-rouge">docker:git</code> contains <code class="highlighter-rouge">docker</code> and <code class="highlighter-rouge">git</code> inside. We can split the entire process into multiple stages and each stage contains multiple jobs. Each job is a stage will be done in parallel and each stage will be triggered only if all jobs in the previous stage is successful.</p> <p>Here, we have two stages, <code class="highlighter-rouge">build</code> and <code class="highlighter-rouge">publish</code>. The job <code class="highlighter-rouge">build</code> is in the <code class="highlighter-rouge">build</code> stage and job <code class="highlighter-rouge">registry</code> in the <code class="highlighter-rouge">publish</code> stage. So, <code class="highlighter-rouge">registry</code> job will be done only if the <code class="highlighter-rouge">build</code> job is successful. The <code class="highlighter-rouge">build</code> job contains a bash command to build the docker image. We can use variables in this script by prepending it with <code class="highlighter-rouge">$</code>. The values for this variables can be given from the Gitlab UI. The image name will be <code class="highlighter-rouge">$REGISTRY_HOST/$IMAGE_NAME</code>. Here, <code class="highlighter-rouge">$REGISTRY_HOST</code> is the registry domain name and <code class="highlighter-rouge">$IMAGE_NAME</code> will be the repository name.</p> <p>In the <code class="highlighter-rouge">registry</code> job, we push this image to the container registry. To do this, we have to login to the registry. Gitlab has a temporary user named <code class="highlighter-rouge">gitlab-ci-token</code> with password in the variable <code class="highlighter-rouge">$CI_BUILD_TOKEN</code> for this purpose. Once with login to the registry at <code class="highlighter-rouge">$REGISTRY_HOST</code>, we can push the docker image.</p> <p>To test this out, create a new public project in Gitlab by importing from Github. In the settings, choose <code class="highlighter-rouge">Variables</code> and add the following two variables.</p> <ul> <li><code class="highlighter-rouge">REGISTRY_HOST</code>: The domain registered for container registry. Example: <code class="highlighter-rouge">registry.botleg.com</code>.</li> <li><code class="highlighter-rouge">IMAGE_NAME</code>: The repository name for the project. Example: <code class="highlighter-rouge">botleg/gitlab-nginx</code>.</li> </ul> <p>Once the repository is imported, goto the <code class="highlighter-rouge">Pipelines</code> tab and click the <code class="highlighter-rouge">Run Pipeline</code> button to trigger the build. You can see the jobs running and image being pushed to the registry. Once the build pipeline is complete, you can see the docker image in the <code class="highlighter-rouge">Registry</code> section of the project.</p> <h2 id="certificate-renewal">Certificate Renewal</h2> <p>The certificates generated by Let’s Encrypt will get expired in 90 days. So, we have to automate the renewal of these certificates. Let’s Encrypt provide a command <code class="highlighter-rouge">letsencrypt renew</code> to do just this. This command will check if the certificates are about to be expired and do the renewal for those. For the renewal to happen, we need to stop the Gitlab service temporarily.</p> <p>The following commands will do the renewal of the certificates,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">gitlab-ctl stop
letsencrypt renew
gitlab-ctl start
gitlab-ctl reconfigure</code></pre></figure> <p>We need to add this as a cron job for the <code class="highlighter-rouge">root</code> user. Open the crontab for <code class="highlighter-rouge">root</code> user with the command <code class="highlighter-rouge">sudo crontab -e</code> and paste the following line.</p> <figure class="highlight"><pre><code class="language-cron" data-lang="cron">0 7 1 * * (gitlab-ctl stop &amp;&amp; letsencrypt renew &amp;&amp; gitlab-ctl start &amp;&amp; gitlab-ctl reconfigure) &gt;&gt; /var/log/report.log 2&gt;&amp;1</code></pre></figure> <p>This will cause this task to run at 7am on the 1st of every month and log the output to the file <code class="highlighter-rouge">/var/log/report.log</code>. Now, we have completely setup Gitlab for the docker based development and also tested it with a git repo.</p> <p class="post-meta">Tags: gitlab, docker, nginx, digitalocean, bash, Dockerfile, CI, letsencrypt, https, ssl, registry, runner, and cloud </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside class="post-aside"> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> <a href="/categories/crypto">Crypto</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/auto-scaling-with-docker/>Auto Scaling with Docker</a><br/><a href=/stories/blue-green-deployment-with-docker/>Building Blue-Green Deployment with Docker</a><br/><a href=/stories/https-with-lets-encrypt-and-nginx/>HTTPS with Let's Encrypt and nginx</a><br/><a href=/stories/load-balancing-with-docker-swarm/>Load Balancing with Docker Swarm</a><br/><a href=/stories/docker-hosting-with-sloppyio/>Docker Hosting with sloppy.io</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading"><a href="/">botleg</a></h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li> <a href="https://github.com/botleg"> <span class="footer-icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#gh"></use> </svg> </span> <span class="username">github</span> </a> </li> <li class="username"> <span class="footer-icon"> <svg viewBox="0 0 24 24" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg> </span> subscribe <a href="/feed">via RSS</a> </li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, devops, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <style type="text/css">body,h1,h2{font-weight:300}.wrapper:after{clear:both}html{box-sizing:border-box}body{background-color:#fdfdfd;color:#111;font-family:Helvetica,Arial,sans-serif;font-size:18px;line-height:1.6;}.wrapper section{margin-top:30px}a{color:#2a7ae2;text-decoration:none}.site-header{min-height:60px;position:relative}.site-title{margin-bottom:0;float:left;font-size:28px;line-height:60px;text-transform:lowercase;color:#e8e8e8}.post-header{box-align:center;justify-content:center;color:#fdfdfd;display:flex;height:300px;margin-bottom:10px}.rss-icon,#searchbox{display:none;}.post-header .header-content{text-align:center;max-width:600px}.icon{background-position:10px center;background-repeat:no-repeat;background-size:30px;padding:0 30px 0 45px}.icon span{color:#fdfdfd;display:none}@media screen and (min-width:400px){.icon span{display:inline}}.post-title{color:#e8e8e8;font-size:36px}.page-content,.post-content{margin-bottom:20px}.page-content h2,.post-content h2{font-size:32px}</style> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v310'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script async type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
