<!DOCTYPE html> <html> <head> <title>Implement Elasticsearch in Jekyll blog</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Elasticsearch is a database based on Apache Lucene and it supports distributed full-text searching and provides a RESTful API. Jekyll is a static site genera..."> <meta name="author" content="Hanzel Jesheen"> <meta itemprop="name" content="Implement Elasticsearch in Jekyll blog"> <meta itemprop="description" content="Elasticsearch is a database based on Apache Lucene and it supports distributed full-text searching and provides a RESTful API. Jekyll is a static site genera..."> <link rel="canonical" href="https://botleg.com/stories/implement-elasticsearch-in-jekyll-blog/"> <link rel="alternate" type="application/rss+xml" title="Botleg" href="https://botleg.com/feed" /> </head> <body> <div class="page-content"> <div class="post"> <header style="background:#f46b45;background:-webkit-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:-moz-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:-ms-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:-o-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:linear-gradient(90deg, #f46b45 10%, #eea849 90%);"> <section class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <a href="/feed/index.xml"><span class="rss-icon"> <svg viewBox="0 0 24 24" width="30px" height="30px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg></span> </a> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </section> <section class="post-header"> <div class="header-content"> <h1 class="post-title">Implement Elasticsearch in Jekyll blog</h1> <a class="icon gh" href="https://github.com/botleg/elasticsearch-jekyll/" target="blank"><span>View Code</span></a> <a class="icon code" href="http://elastic.jekyll.botleg.com/" target="blank"><span>View Demo</span></a> </div> </section> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Sep 6, 2015 | <a href="/categories/jekyll">jekyll</a> </p> <p><a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> is a database based on Apache Lucene and it supports distributed full-text searching and provides a RESTful API. <a href="http://jekyllrb.com">Jekyll</a> is a static site generator used mainly as blog generator. We can use Elasticsearch to index the blog posts and it can then be searched efficently. In this article, we will see how to implement Elasticsearch based searching to a Jekyll blog. You will need to know the basics of Jekyll and Node.js, or any other language to create an web API backend.</p> <p>The working demo for this article is hosted <a href="http://elastic.jekyll.botleg.com/">here</a> and the code for this can be found <a href="https://github.com/botleg/elasticsearch-jekyll/">here</a>. The repository contains two branches, a <code class="highlighter-rouge">master</code> branch which has an web API made using Node.js which handles the communication with Elasticsearch server and a <code class="highlighter-rouge">gh-pages</code> branch which contains our blog made using Jekyll.</p> <p>The Jekyll blog is hosted using <code class="highlighter-rouge">GitHub Pages</code>, which is used to host static or Jekyll generated sites for free. For any repository, you can add an orphan branch named <code class="highlighter-rouge">gh-pages</code> and it will be hosted by <code class="highlighter-rouge">GitHub Pages</code>. You can read more about this <a href="https://help.github.com/articles/using-jekyll-with-pages/">here</a>.</p> <p>##Appbase.io <a href="https://appbase.io/">Appbase.io</a> is a Database as a service solution that provides hosted Elasticsearch endpoints. The free plan includes 100MB storage and 100K API calls per month at the time of writing. It would suffice for testing purposes. Go ahead, sign up there and create an application. You can get the username and password for your application from the dashboard by clicking Credentials.</p> <p><img src="/assets/images/appbase-dash@2x.jpg" srcset="/assets/images/appbase-dash@1x.jpg 300w, /assets/images/appbase-dash@2x.jpg 600w, /assets/images/appbase-dash@3x.jpg 900w" sizes="(min-width: 960px) 900px, 100vw" alt="Appbase.io Dashboard" class="center-image" /> <em class="image-caption">Appbase.io Dashboard</em></p> <p>##Node.js Backend We will start with the backend API that handles all communication with Elasticsearch and gives us the search results for the front-end. It uses <a href="http://koajs.com/">Koa</a> web framework, which is a really good framework for developing API with Node.js and it supports Javascript ES6, so you should have atleast <code class="highlighter-rouge">v0.11</code> of Node.js and use the <code class="highlighter-rouge">--harmony</code> flag. You can see the entire code for this backend <a href="https://github.com/botleg/elasticsearch-jekyll/tree/master">here</a>.</p> <p>It is hosted with <a href="https://www.openshift.com/">OpenShift</a> which provide 3 <code class="highlighter-rouge">gears</code> for free. You can host this application in one of those gears. The <code class="highlighter-rouge">.openshift</code> folder is the repository contains scripts to update Node.js from v0.10, which is default in OpenShift, to v0.12.4. You can find information about this <a href="https://github.com/ryanj/nodejs-custom-version-openshift">here</a>.</p> <p>The entry point of the application will be called <code class="highlighter-rouge">index.js</code> and we will have the file <code class="highlighter-rouge">config.js</code>, for storing the configuration and <code class="highlighter-rouge">route.js</code>, for handling Koa routes.</p> <p><code class="highlighter-rouge">config.js</code> contains the appbase.io and openshift configurations. You can hard code the values or use environment variables. Values for <code class="highlighter-rouge">ip</code> and <code class="highlighter-rouge">port</code> allows us to test it in local system and to host it in OpenShift. The <code class="highlighter-rouge">baseurl</code> parameter is required for us to get the raw data of the files in the Jekyll repository. You can obtain it by replacing your github personal or organization name, repository name and branch name in <code class="highlighter-rouge">https://raw.githubusercontent.com/{your-id-here}/{your-repo-name-here}/{your-branch-name-here}/</code>. The search object in the <code class="highlighter-rouge">search</code> object in <code class="highlighter-rouge">config.js</code> is used as search options for Elasticsearch API. More about these options can be found <a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/api-reference.html#api-search">here</a>. Feel free to play with these options till the search results become correct for you. The complete code for <code class="highlighter-rouge">config.js</code> is given below.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">ip</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENSHIFT_NODEJS_IP</span> <span class="o">||</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
  <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENSHIFT_NODEJS_PORT</span> <span class="o">||</span> <span class="mi">8000</span><span class="p">,</span>
  <span class="na">baseurl</span><span class="p">:</span> <span class="s1">'https://raw.githubusercontent.com/{your-id-here}/{your-repo-name-here}/{your-branch-name-here}/'</span><span class="p">,</span>
  <span class="na">hostname</span><span class="p">:</span> <span class="s1">'scalr.api.appbase.io'</span><span class="p">,</span>
  <span class="na">appname</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>  <span class="c1">// appbase.io application name here</span>
  <span class="na">username</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">// appbase.io application username here</span>
  <span class="na">password</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">// appbase.io application password here</span>
  <span class="na">collection</span><span class="p">:</span> <span class="s1">'posts'</span><span class="p">,</span>

  <span class="na">search</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">multi_match</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="s1">'best_fields'</span><span class="p">,</span>
        <span class="na">fuzziness</span><span class="p">:</span> <span class="s1">'AUTO'</span><span class="p">,</span>
        <span class="na">tie_breaker</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="na">fields</span><span class="p">:</span> <span class="p">[</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">_source</span><span class="p">:</span> <span class="p">[</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'summary'</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></figure> <p>In <code class="highlighter-rouge">index.js</code>, we create a Elasticsearch client with out configurations.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">elasticsearch</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span>
  <span class="na">host</span><span class="p">:</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">username</span><span class="o">+</span><span class="s2">":"</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">password</span><span class="o">+</span><span class="s2">"@"</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
<span class="p">});</span></code></pre></figure> <p>We also setup Koa in <code class="highlighter-rouge">index.js</code>. It’s complete code is given below.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">)(),</span>
    <span class="nx">elasticsearch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'elasticsearch'</span><span class="p">),</span>
    <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./config'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">elasticsearch</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span>
  <span class="na">host</span><span class="p">:</span> <span class="s1">'https://'</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">username</span><span class="o">+</span><span class="s2">":"</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">password</span><span class="o">+</span><span class="s2">"@"</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./route.js'</span><span class="p">)(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'X-Response-Time'</span><span class="p">,</span> <span class="nx">ms</span> <span class="o">+</span> <span class="s1">'ms'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'%s %s - %s'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">allowedMethods</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ip</span><span class="p">);</span></code></pre></figure> <p>The magic happens in the <code class="highlighter-rouge">route.js</code> file. We will start with basic imports. The router objects accepts both Elasticsearch client and configurations object as the parameters. We also create two routes, one returns null and one returns the number of records in the Elasticsearch index.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-router'</span><span class="p">)(),</span>
    <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-body'</span><span class="p">)(),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'co-request'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/count'</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
      <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">router</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure> <p>Now, the real problem involved in implementing Elasticsearch with a Jekyll blog is how we index the posts in Elasticsearch. This must happen automatically, so I used <a href="https://developer.github.com/webhooks/">GitHub Webhooks</a>. Every time I push a commit to the Jekyll repository, GitHub will send a <code class="highlighter-rouge">POST</code> request containing a JSON payload with the changes to the url I specify. I will handle that request with this app where I add, edit or delete records in my Elasticsearch index based on the file changes. We will use the route <code class="highlighter-rouge">/commit</code> for this. An example JSON payload for the push event can be found <a href="https://developer.github.com/v3/activity/events/types/#pushevent">here</a>.</p> <p>Our Elasticsearch index will be the appbase.io appname and type will be called <code class="highlighter-rouge">posts</code>. The <code class="highlighter-rouge">_id</code> field for the record will be the posts’s filename without the date and extension. There will be 3 fields for each posts, <code class="highlighter-rouge">title</code> with the post title, <code class="highlighter-rouge">summary</code> with post summary and <code class="highlighter-rouge">text</code> with raw contents of the post. We will search in the <code class="highlighter-rouge">title</code> and <code class="highlighter-rouge">text</code> fields.</p> <p>We will go through each commit in the push event payload. We need to look for three events: add, edit and delete. If a new file is added in the commit, it will be there in <code class="highlighter-rouge">added</code> object inside the <code class="highlighter-rouge">commit</code> object. As the posts for a Jekyll blog are inside <code class="highlighter-rouge">_posts</code> folder, we need check whether <code class="highlighter-rouge">_posts</code> is there in the file path. If it is there, we will add a new entry to our Elasticsearch index with <code class="highlighter-rouge">id</code> by removing <code class="highlighter-rouge">_posts</code>, date and extension from the file path. If <code class="highlighter-rouge">add</code> is the file path, we can get that with,</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span></code></pre></figure> <p>The raw data of the file is requested with,</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">)</span></code></pre></figure> <p>We take the summary and title of the new entry from the second and third line of the markdown respectively. This is based on how we write the front-matter in the Jekyll posts. We will get to that later. This can be done with,</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">body</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">title</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
  <span class="nx">summary</span><span class="err">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
  <span class="nx">text</span><span class="err">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
  <span class="nx">comments</span><span class="err">:</span> <span class="p">[]</span>
<span class="p">}</span></code></pre></figure> <p>The <code class="highlighter-rouge">slice</code> functions are used above to remove the word <code class="highlighter-rouge">title</code> from the title itself and so on.</p> <p>Now, we have seen how to handle the post addition. Similar procedure is done for deletion and modification of the posts. The complete code for <code class="highlighter-rouge">/commit</code> route can be seen here.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/commit'</span><span class="p">,</span> <span class="nx">koaBody</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">commit</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">added</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'_posts/'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
          <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span>
            <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
            <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">title</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
              <span class="na">summary</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
              <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
              <span class="na">comments</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'_posts/'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span>
            <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">modified</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'_posts/'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
          <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
            <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
            <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">doc</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">title</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
                <span class="na">summary</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span></code></pre></figure> <p>Now that we have the indexing ready, we can add the search route. We use the search object in <code class="highlighter-rouge">config.js</code> as search option and use request parameter as the query. We use the Elasticsearch client to search and we list of the search results with the id, title and summary fields. We will also provide the required headers. The <code class="highlighter-rouge">search/:q</code> route is given below.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/search/:q'</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">multi_match</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span>
    <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">search</span>
  <span class="p">});</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">item</span> <span class="nx">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'Access-Control-Allow-Origin'</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'Cache-Control'</span><span class="p">,</span> <span class="s1">'max-age=3600'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'application/json'</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">});</span></code></pre></figure> <p>That’s all there is for <code class="highlighter-rouge">route.js</code> and its complete code is given below.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-router'</span><span class="p">)(),</span>
    <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-body'</span><span class="p">)(),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'co-request'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/count'</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
      <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/search/:q'</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">multi_match</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span>
      <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">search</span>
    <span class="p">});</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">item</span> <span class="nx">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'Access-Control-Allow-Origin'</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'Cache-Control'</span><span class="p">,</span> <span class="s1">'max-age=3600'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'application/json'</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/commit'</span><span class="p">,</span> <span class="nx">koaBody</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">commit</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">added</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'_posts/'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
            <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span>
              <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
              <span class="na">type</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
              <span class="na">id</span><span class="p">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
              <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">title</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                <span class="na">summary</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
                <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
                <span class="na">comments</span><span class="p">:</span> <span class="p">[]</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'_posts/'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span>
              <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
              <span class="na">type</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
              <span class="na">id</span><span class="p">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">modified</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'_posts/'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
            <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
              <span class="na">index</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
              <span class="na">type</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
              <span class="na">id</span><span class="p">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
              <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">doc</span><span class="p">:</span> <span class="p">{</span>
                  <span class="na">title</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                  <span class="na">text</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
                  <span class="na">summary</span><span class="p">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">router</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure> <p>We have completed the backend now and it’s ready for hosting. Again, the complete code for these files can be found <a href="https://github.com/botleg/elasticsearch-jekyll/tree/master">here</a>.</p> <p>##Jekyll Fontend Before we start with Jekyll, create a branch <code class="highlighter-rouge">gh-pages</code> in Github and add a webhook to <code class="highlighter-rouge">/commit</code> route of the back-end app. Check this <a href="https://developer.github.com/webhooks/">link</a> for more about GitHub Webhooks.</p> <p>Create a new orphan branch and create a basic Jekyll blog with the following commands,</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout --orphan gh-pages
git rm -rf .
gem install jekyll
jekyll new . -f</code></pre></figure> <p>Once this blog is scaffolded by Jekyll, we can put some dummy posts for test purpose. The front-matter the blog must be in the given format itself. The second line contains <code class="highlighter-rouge">summary:</code> followed by a single space and the post summary. The third line contains <code class="highlighter-rouge">title:</code> followed by a single space and the post title. The rest can be in any order and format. This is done as we are taking the summary and title for the Elasticsearch index from the second and third line of the front-matter respectively. The front-matter of a post can look like this.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">---</span>
<span class="nx">summary</span><span class="err">:</span> <span class="nx">Far</span> <span class="nx">far</span> <span class="nx">away</span><span class="p">,</span> <span class="nx">behind</span> <span class="nx">the</span> <span class="nx">word</span> <span class="nx">mountains</span><span class="p">,</span> <span class="nx">far</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">countries</span> <span class="nx">Vokalia</span> <span class="nx">and</span> <span class="nx">Consonantia</span><span class="p">,</span> <span class="nx">there</span> <span class="nx">live</span> <span class="nx">the</span> <span class="nx">blind</span> <span class="nx">texts</span>
<span class="nl">title</span><span class="p">:</span> <span class="nx">Far</span> <span class="nx">Far</span> <span class="nx">Away</span>
<span class="nl">layout</span><span class="p">:</span> <span class="nx">post</span>
<span class="nl">date</span><span class="p">:</span>   <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">01</span> <span class="mi">18</span><span class="err">:</span><span class="mi">23</span><span class="err">:</span><span class="mi">42</span>
<span class="nl">categories</span><span class="p">:</span> <span class="nx">jekyll</span> <span class="nx">update</span>
<span class="o">---</span></code></pre></figure> <p>To add search box and button to all pages, we add the following to <code class="highlighter-rouge">_includes/header.html</code>. The styling is up to you.</p> <figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"search"</span> <span class="na">id=</span><span class="s">"searchform"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"searchbox"</span> <span class="na">id=</span><span class="s">"searchbox"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Search"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre></figure> <p>We also need a page to show the search results. So, add a new page <code class="highlighter-rouge">search/index.html</code> with the following contents,</p> <figure class="highlight"><pre><code class="language-html" data-lang="html">---
layout: default
type: search
---

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"home"</span><span class="nt">&gt;</span>
  
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"page-heading"</span><span class="nt">&gt;</span>Search results for '<span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"query"</span><span class="nt">&gt;&lt;/span&gt;</span>'<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"post-list"</span> <span class="na">id=</span><span class="s">"post-list"</span><span class="nt">&gt;</span>
    {% for post in site.posts %}
      <span class="nt">&lt;li&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"post-meta"</span><span class="nt">&gt;</span>{{ post.date | date: '%b %-d, %Y' }}<span class="nt">&lt;/span&gt;</span>

        <span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">class=</span><span class="s">"post-link"</span> <span class="na">href=</span><span class="s">"{{ post.url | prepend: site.baseurl }}"</span><span class="nt">&gt;</span>{{ post.title }}<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>{{ post.summary }}<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/li&gt;</span>
    {% endfor %}
  <span class="nt">&lt;/ul&gt;</span>

<span class="nt">&lt;/div&gt;</span></code></pre></figure> <p>Most of the work here is done in javascript, let’s create two javascript files in the folder <code class="highlighter-rouge">js</code> folder. We create <code class="highlighter-rouge">search.js</code> for the search page and <code class="highlighter-rouge">home.js</code> for all other pages. To attach these javascript files to the corresponding files, add the following to the end of <code class="highlighter-rouge">_includes/footer.html</code>,</p> <figure class="highlight"><pre><code class="language-html" data-lang="html">{% if page.type == 'search' %}
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/js/search.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
{% else %}
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/js/home.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
{% endif %}</code></pre></figure> <p>In <code class="highlighter-rouge">home.js</code>, we need to handle the search form submit. Once form is submitted with something in the searchbox, we can send then to <code class="highlighter-rouge">/search#query</code>, where <code class="highlighter-rouge">query</code> is the searched query. So, <code class="highlighter-rouge">home.js</code> will be as below. So if the webpage is <code class="highlighter-rouge">botleg.com</code> and <code class="highlighter-rouge">query</code> is <code class="highlighter-rouge">test</code>, the resulting page will be <code class="highlighter-rouge">botleg.com/search/#test</code></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'searchform'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">search</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'searchbox'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">'/search/#'</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'searchbox'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'+'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"submit"</span><span class="p">,</span> <span class="nx">search</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">'onsubmit'</span><span class="p">,</span> <span class="nx">search</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure> <p>In <code class="highlighter-rouge">search.js</code>, we can read the search query with,</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></code></pre></figure> <p>We will send a <code class="highlighter-rouge">GET</code> request to the <code class="highlighter-rouge">/search/:q</code> with AJAX, where <code class="highlighter-rouge">:q</code> is replaced by the search query and its response contains the search results. These are then injected into the web page. You can search for another query and a new request will be sent. Complete code for <code class="highlighter-rouge">search.js</code> is given below.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'searchform'</span><span class="p">),</span>
    <span class="nx">box</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'searchbox'</span><span class="p">),</span>
    <span class="nx">span</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'query'</span><span class="p">),</span>
    <span class="nx">list</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'post-list'</span><span class="p">),</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&lt;span class="text"&gt;Sorry, No results.&lt;/span&gt;'</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="s1">'&lt;li&gt;&lt;a class="post-link" href="/posts/'</span> <span class="o">+</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">'"&gt;'</span> <span class="o">+</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">'&lt;/a&gt;&lt;p&gt;'</span> <span class="o">+</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">summary</span> <span class="o">+</span> <span class="s1">'&lt;/p&gt;&lt;/li&gt;'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">search</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'+'</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">);</span>
  <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'&lt;span class="text"&gt;Loading results...&lt;/span&gt;'</span><span class="p">;</span>

  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="s1">'http://elastic.api.botleg.com/search/'</span> <span class="o">+</span> <span class="nx">query</span><span class="p">));</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">searchFrm</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="nx">box</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'+'</span><span class="p">);</span>
    <span class="nx">search</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">box</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'+'</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">);</span>
<span class="nx">search</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"submit"</span><span class="p">,</span> <span class="nx">searchFrm</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">'onsubmit'</span><span class="p">,</span> <span class="nx">searchFrm</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure> <p>That’s all there is. Once you push your changes to GitHub, the posts will be indexed by Elasticsearch and these can then be searched. The code for the Jekyll Frontend can be found <a href="https://github.com/botleg/elasticsearch-jekyll/tree/gh-pages">here</a>.</p> <p>##TL;DR The working demo for this article is hosted <a href="http://elastic.jekyll.botleg.com/">here</a> and the code for this can be found <a href="https://github.com/botleg/elasticsearch-jekyll/">here</a>. We can create an Elasticsearch endpoint using <a href="https://appbase.io/">appbase.io</a>. Then we need a web API backend to handle Webhooks. From Webhooks, we can get the information about file changes in Jekyll repository which can then used to index these posts with Elasticsearch. Once these are indexed, we can use AJAX requests to Elasticsearch and show search results by injecting it into webpage. And that’s one way to implement Elasticsearch in a Jekyll Blog.</p> <p class="post-meta">Tags: elasticsearch, appbase.io, lucene, github-pages, node.js, koa, openshift, webhooks, javascript, markdown, ajax, and jekyll </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside class="post-aside"> <div class ="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/misc">Misc</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/Node.js">Node.js</a><br/> <a href="/categories/javascript">Javascript</a><br/> <a href="/categories/devops">Devops</a><br/> </div> <div class ="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/hello-world/>hello world :)</a><br/><a href=/stories/build-and-deploy-to-openshift-with-travisci-and-wercker/>Build and Deploy to OpenShift with TravisCI and Wercker</a><br/><a href=/stories/using-your-sessions-with-socketio/>Using your sessions with Socket.IO</a><br/><a href=/stories/auto-scaling-with-docker/>Auto Scaling with Docker</a><br/><a href=/stories/orchestrate-docker-containers-with-tutum/>Orchestrate Docker containers with Tutum</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading"><a href="/">botleg</a></h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li> <a href="https://github.com/botleg"> <span class="footer-icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#gh"></use> </svg> </span> <span class="username">github</span> </a> </li> <li class="username"> <span class="footer-icon"> <svg viewBox="0 0 24 24" width="16px" height="16px"> <use xlink:href="/assets/images/sprites.svg#rss"></use> </svg> </span> subscribe <a href="/feed">via RSS</a> </li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, devops, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <style type="text/css">body,h1,h2{font-weight:300}.wrapper:after{clear:both}html{box-sizing:border-box}body{background-color:#fdfdfd;color:#111;font-family:Helvetica,Arial,sans-serif;font-size:18px;line-height:1.6;}.wrapper section{margin-top:30px}a{color:#2a7ae2;text-decoration:none}.site-header{min-height:60px;position:relative}.site-title{margin-bottom:0;float:left;font-size:28px;line-height:60px;text-transform:lowercase;color:#e8e8e8}.post-header{box-align:center;justify-content:center;color:#fdfdfd;display:flex;height:300px;margin-bottom:10px}.rss-icon,#searchbox{display:none;}.post-header .header-content{text-align:center;max-width:600px}.icon{background-position:10px center;background-repeat:no-repeat;background-size:30px;padding:0 30px 0 45px}.icon span{color:#fdfdfd;display:none}@media screen and (min-width:400px){.icon span{display:inline}}.post-title{color:#e8e8e8;font-size:36px}.page-content,.post-content{margin-bottom:20px}.page-content h2,.post-content h2{font-size:32px}</style> <script> var cb = function() { var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/assets/main.css?v310'; var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h); }; var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener('load', cb); </script> <script async type="text/javascript" src="/assets/js/post.js"></script> </body> </html>
