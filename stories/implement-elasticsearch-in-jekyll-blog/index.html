<!DOCTYPE html> <html> <head> <title>Implement Elasticsearch in Jekyll blog</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="Elasticsearch is a database based on Apache Lucene and it supports distributed full-text searching and provides a RESTful API. Jekyll is a static site genera..."> <meta name="author" content="Hanzel Jesheen"> <meta name="twitter:card" content="summary"/> <meta name="twitter:site" content="@HanzelJesheen"/> <meta name="twitter:creator" content="@HanzelJesheen"/> <meta property="og:url" content="http://botleg.com/stories/implement-elasticsearch-in-jekyll-blog"/> <meta property="og:type" content="article"/> <meta property="og:title" content="Implement Elasticsearch in Jekyll blog"/> <meta property="og:description" content="Elasticsearch is a database used for full-text searching and Jekyll is a static blog generator. In this article, we will see how to implement Elasticsearch based searching to a Jekyll blog."/> <meta property="og:image" content=""/> <meta property="og:site_name" content="botleg"/> <meta property="article:author" content="Hanzel Jesheen"/> <meta itemprop="name" content="Implement Elasticsearch in Jekyll blog"> <meta itemprop="description" content="Elasticsearch is a database based on Apache Lucene and it supports distributed full-text searching and provides a RESTful API. Jekyll is a static site genera..."> <link rel="canonical" href="http://botleg.com/stories/implement-elasticsearch-in-jekyll-blog"> <link rel="alternate" type="application/rss+xml" title="Botleg" href="http://botleg.com/feed"/> </head> <body> <header class="site-header"> <div class="wrapper"> <a class="site-title" href="/">Botleg</a> <div id="search"> <form id="searchform"> <input type="text" placeholder="search" id="searchbox"> </form> </div> </div> </header> <div class="page-content"> <div class="post"> <header class="post-header" style="background:#f46b45;background:-webkit-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:-moz-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:-ms-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:-o-linear-gradient(90deg, #f46b45 10%, #eea849 90%);background:linear-gradient(90deg, #f46b45 10%, #eea849 90%);"> <div class="header-content"> <h1 class="post-title">Implement Elasticsearch in Jekyll blog</h1> <a class="icon gh" href="https://github.com/botleg/elasticsearch-jekyll/" target="blank"><span>View Code</span></a> <a class="icon code" href="http://elastic.jekyll.botleg.com/" target="blank"><span>View Demo</span></a> </div> </header> <div class="wrapper"> <section> <article class="post-content"> <p class="post-meta">Written by Hanzel Jesheen on Sep 6, 2015 | <a href="/categories/jekyll">jekyll</a> </p> <p><a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> is a database based on Apache Lucene and it supports distributed full-text searching and provides a RESTful API. <a href="http://jekyllrb.com">Jekyll</a> is a static site generator used mainly as blog generator. We can use Elasticsearch to index the blog posts and it can then be searched efficently. In this article, we will see how to implement Elasticsearch based searching to a Jekyll blog. You will need to know the basics of Jekyll and Node.js, or any other language to create an web API backend.</p> <p>The working demo for this article is hosted <a href="http://elastic.jekyll.botleg.com/">here</a> and the code for this can be found <a href="https://github.com/botleg/elasticsearch-jekyll/">here</a>. The repository contains two branches, a <code>master</code> branch which has an web API made using Node.js which handles the communication with Elasticsearch server and a <code>gh-pages</code> branch which contains our blog made using Jekyll.</p> <p>The Jekyll blog is hosted using <code>GitHub Pages</code>, which is used to host static or Jekyll generated sites for free. For any repository, you can add an orphan branch named <code>gh-pages</code> and it will be hosted by <code>GitHub Pages</code>. You can read more about this <a href="https://help.github.com/articles/using-jekyll-with-pages/">here</a>.</p> <h2 id="appbaseio">Appbase.io</h2> <p><a href="https://appbase.io/">Appbase.io</a> is a Database as a service solution that provides hosted Elasticsearch endpoints. The free plan includes 100MB storage and 100K API calls per month at the time of writing. It would suffice for testing purposes. Go ahead, sign up there and create an application. You can get the username and password for your application from the dashboard by clicking Credentials.</p> <div class="image-wrapper" style="text-align: center"> <img src="/assets/images/appbase-dash.jpg" alt="Appbase.io Dashboard" style="max-width: 100%; vertical-align: middle"/> <p class="image-caption" style="color: #828282; font-size: 16px; margin-top: 4px;">Appbase.io Dashboard</p> </div> <h2 id="nodejs-backend">Node.js Backend</h2> <p>We will start with the backend API that handles all communication with Elasticsearch and gives us the search results for the front-end. It uses <a href="http://koajs.com/">Koa</a> web framework, which is a really good framework for developing API with Node.js and it supports Javascript ES6, so you should have atleast <code>v0.11</code> of Node.js and use the <code>--harmony</code> flag. You can see the entire code for this backend <a href="https://github.com/botleg/elasticsearch-jekyll/tree/master">here</a>.</p> <p>It is hosted with <a href="https://www.openshift.com/">OpenShift</a> which provide 3 <code>gears</code> for free. You can host this application in one of those gears. The <code>.openshift</code> folder is the repository contains scripts to update Node.js from v0.10, which is default in OpenShift, to v0.12.4. You can find information about this <a href="https://github.com/ryanj/nodejs-custom-version-openshift">here</a>.</p> <p>The entry point of the application will be called <code>index.js</code> and we will have the file <code>config.js</code>, for storing the configuration and <code>route.js</code>, for handling Koa routes.</p> <p><code>config.js</code> contains the appbase.io and openshift configurations. You can hard code the values or use environment variables. Values for <code>ip</code> and <code>port</code> allows us to test it in local system and to host it in OpenShift. The <code>baseurl</code> parameter is required for us to get the raw data of the files in the Jekyll repository. You can obtain it by replacing your github personal or organization name, repository name and branch name in <code>https://raw.githubusercontent.com/{your-id-here}/{your-repo-name-here}/{your-branch-name-here}/</code>. The search object in the <code>search</code> object in <code>config.js</code> is used as search options for Elasticsearch API. More about these options can be found <a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/api-reference.html#api-search">here</a>. Feel free to play with these options till the search results become correct for you. The complete code for <code>config.js</code> is given below.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">ip</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENSHIFT_NODEJS_IP</span> <span class="o">||</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENSHIFT_NODEJS_PORT</span> <span class="o">||</span> <span class="mi">8000</span><span class="p">,</span>
  <span class="nx">baseurl</span><span class="o">:</span> <span class="s1">&#39;https://raw.githubusercontent.com/{your-id-here}/{your-repo-name-here}/{your-branch-name-here}/&#39;</span><span class="p">,</span>
  <span class="nx">hostname</span><span class="o">:</span> <span class="s1">&#39;scalr.api.appbase.io&#39;</span><span class="p">,</span>
  <span class="nx">appname</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1">// appbase.io application name here</span>
  <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// appbase.io application username here</span>
  <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// appbase.io application password here</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="s1">&#39;posts&#39;</span><span class="p">,</span>

  <span class="nx">search</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">multi_match</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;best_fields&#39;</span><span class="p">,</span>
        <span class="nx">fuzziness</span><span class="o">:</span> <span class="s1">&#39;AUTO&#39;</span><span class="p">,</span>
        <span class="nx">tie_breaker</span><span class="o">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="nx">fields</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">_source</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></div> <p>In <code>index.js</code>, we create a Elasticsearch client with out configurations.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">elasticsearch</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span>
  <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;https://&#39;</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">username</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">password</span><span class="o">+</span><span class="s2">&quot;@&quot;</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
<span class="p">});</span></code></pre></div> <p>We also setup Koa in <code>index.js</code>. It’s complete code is given below.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">)(),</span>
    <span class="nx">elasticsearch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;elasticsearch&#39;</span><span class="p">),</span>
    <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./config&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">elasticsearch</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span>
  <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;https://&#39;</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">username</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">password</span><span class="o">+</span><span class="s2">&quot;@&quot;</span><span class="o">+</span><span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./route.js&#39;</span><span class="p">)(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;X-Response-Time&#39;</span><span class="p">,</span> <span class="nx">ms</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;%s %s - %s&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">allowedMethods</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ip</span><span class="p">);</span></code></pre></div> <p>The magic happens in the <code>route.js</code> file. We will start with basic imports. The router objects accepts both Elasticsearch client and configurations object as the parameters. We also create two routes, one returns null and one returns the number of records in the Elasticsearch index.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-router&#39;</span><span class="p">)(),</span>
    <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-body&#39;</span><span class="p">)(),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;co-request&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/count&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
      <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">router</span><span class="p">;</span>
<span class="p">};</span></code></pre></div> <p>Now, the real problem involved in implementing Elasticsearch with a Jekyll blog is how we index the posts in Elasticsearch. This must happen automatically, so I used <a href="https://developer.github.com/webhooks/">GitHub Webhooks</a>. Every time I push a commit to the Jekyll repository, GitHub will send a <code>POST</code> request containing a JSON payload with the changes to the url I specify. I will handle that request with this app where I add, edit or delete records in my Elasticsearch index based on the file changes. We will use the route <code>/commit</code> for this. An example JSON payload for the push event can be found <a href="https://developer.github.com/v3/activity/events/types/#pushevent">here</a>.</p> <p>Our Elasticsearch index will be the appbase.io appname and type will be called <code>posts</code>. The <code>_id</code> field for the record will be the posts’s filename without the date and extension. There will be 3 fields for each posts, <code>title</code> with the post title, <code>summary</code> with post summary and <code>text</code> with raw contents of the post. We will search in the <code>title</code> and <code>text</code> fields.</p> <p>We will go through each commit in the push event payload. We need to look for three events: add, edit and delete. If a new file is added in the commit, it will be there in <code>added</code> object inside the <code>commit</code> object. As the posts for a Jekyll blog are inside <code>_posts</code> folder, we need check whether <code>_posts</code> is there in the file path. If it is there, we will add a new entry to our Elasticsearch index with <code>id</code> by removing <code>_posts</code>, date and extension from the file path. If <code>add</code> is the file path, we can get that with,</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span></code></pre></div> <p>The raw data of the file is requested with,</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">)</span></code></pre></div> <p>We take the summary and title of the new entry from the second and third line of the markdown respectively. This is based on how we write the front-matter in the Jekyll posts. We will get to that later. This can be done with,</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">title</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
  <span class="nx">summary</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
  <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
  <span class="nx">comments</span><span class="o">:</span> <span class="p">[]</span>
<span class="p">}</span></code></pre></div> <p>The <code>slice</code> functions are used above to remove the word <code>title</code> from the title itself and so on.</p> <p>Now, we have seen how to handle the post addition. Similar procedure is done for deletion and modification of the posts. The complete code for <code>/commit</code> route can be seen here.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/commit&#39;</span><span class="p">,</span> <span class="nx">koaBody</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">commit</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">added</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_posts/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
          <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span>
            <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
            <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">title</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
              <span class="nx">summary</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
              <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
              <span class="nx">comments</span><span class="o">:</span> <span class="p">[]</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_posts/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span>
            <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">modified</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_posts/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
          <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
            <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
            <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">doc</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
                <span class="nx">summary</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span></code></pre></div> <p>Now that we have the indexing ready, we can add the search route. We use the search object in <code>config.js</code> as search option and use request parameter as the query. We use the Elasticsearch client to search and we list of the search results with the id, title and summary fields. We will also provide the required headers. The <code>search/:q</code> route is given below.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/search/:q&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">multi_match</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span>
    <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">search</span>
  <span class="p">});</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">item</span> <span class="nx">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span> <span class="s1">&#39;max-age=3600&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">});</span></code></pre></div> <p>That’s all there is for <code>route.js</code> and its complete code is given below.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-router&#39;</span><span class="p">)(),</span>
    <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-body&#39;</span><span class="p">)(),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;co-request&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/count&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
      <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/search/:q&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">multi_match</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span>
      <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">search</span>
    <span class="p">});</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">item</span> <span class="nx">of</span> <span class="nx">state</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">_source</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span> <span class="s1">&#39;max-age=3600&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/commit&#39;</span><span class="p">,</span> <span class="nx">koaBody</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">commit</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">commits</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">added</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_posts/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
            <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span>
              <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
              <span class="nx">id</span><span class="o">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
              <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                <span class="nx">summary</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
                <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
                <span class="nx">comments</span><span class="o">:</span> <span class="p">[]</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_posts/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span>
              <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
              <span class="nx">id</span><span class="o">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">add</span> <span class="nx">of</span> <span class="nx">commit</span><span class="p">.</span><span class="nx">modified</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_posts/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseurl</span> <span class="o">+</span> <span class="nx">add</span><span class="p">);</span>
            <span class="k">yield</span> <span class="nx">client</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
              <span class="nx">index</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appname</span><span class="p">,</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
              <span class="nx">id</span><span class="o">:</span> <span class="nx">add</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nx">add</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">9</span><span class="p">),</span>
              <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">doc</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">title</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                  <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
                  <span class="nx">summary</span><span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">router</span><span class="p">;</span>
<span class="p">};</span></code></pre></div> <p>We have completed the backend now and it’s ready for hosting. Again, the complete code for these files can be found <a href="https://github.com/botleg/elasticsearch-jekyll/tree/master">here</a>.</p> <h2 id="jekyll-fontend">Jekyll Fontend</h2> <p>Before we start with Jekyll, create a branch <code>gh-pages</code> in Github and add a webhook to <code>/commit</code> route of the back-end app. Check this <a href="https://developer.github.com/webhooks/">link</a> for more about GitHub Webhooks.</p> <p>Create a new orphan branch and create a basic Jekyll blog with the following commands,</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout --orphan gh-pages
git rm -rf .
gem install jekyll
jekyll new . -f</code></pre></div> <p>Once this blog is scaffolded by Jekyll, we can put some dummy posts for test purpose. The front-matter the blog must be in the given format itself. The second line contains <code>summary:</code> followed by a single space and the post summary. The third line contains <code>title:</code> followed by a single space and the post title. The rest can be in any order and format. This is done as we are taking the summary and title for the Elasticsearch index from the second and third line of the front-matter respectively. The front-matter of a post can look like this.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">---</span>
<span class="nx">summary</span><span class="o">:</span> <span class="nx">Far</span> <span class="nx">far</span> <span class="nx">away</span><span class="p">,</span> <span class="nx">behind</span> <span class="nx">the</span> <span class="nx">word</span> <span class="nx">mountains</span><span class="p">,</span> <span class="nx">far</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">countries</span> <span class="nx">Vokalia</span> <span class="nx">and</span> <span class="nx">Consonantia</span><span class="p">,</span> <span class="nx">there</span> <span class="nx">live</span> <span class="nx">the</span> <span class="nx">blind</span> <span class="nx">texts</span>
<span class="nx">title</span><span class="o">:</span> <span class="nx">Far</span> <span class="nx">Far</span> <span class="nx">Away</span>
<span class="nx">layout</span><span class="o">:</span> <span class="nx">post</span>
<span class="nx">date</span><span class="o">:</span>   <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">01</span> <span class="mi">18</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mi">42</span>
<span class="nx">categories</span><span class="o">:</span> <span class="nx">jekyll</span> <span class="nx">update</span>
<span class="o">---</span></code></pre></div> <p>To add search box and button to all pages, we add the following to <code>_includes/header.html</code>. The styling is up to you.</p> <div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;search&quot;</span> <span class="na">id=</span><span class="s">&quot;searchform&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;searchbox&quot;</span> <span class="na">id=</span><span class="s">&quot;searchbox&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Search&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre></div> <p>We also need a page to show the search results. So, add a new page <code>search/index.html</code> with the following contents,</p> <div class="highlight"><pre><code class="language-html" data-lang="html">---
layout: default
type: search
---

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;home&quot;</span><span class="nt">&gt;</span>
  
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">&quot;page-heading&quot;</span><span class="nt">&gt;</span>Search results for &#39;<span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;query&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>&#39;<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;post-list&quot;</span> <span class="na">id=</span><span class="s">&quot;post-list&quot;</span><span class="nt">&gt;</span>
    {% for post in site.posts %}
      <span class="nt">&lt;li&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;post-meta&quot;</span><span class="nt">&gt;</span>{{ post.date | date: &#39;%b %-d, %Y&#39; }}<span class="nt">&lt;/span&gt;</span>

        <span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;post-link&quot;</span> <span class="na">href=</span><span class="s">&quot;{{ post.url | prepend: site.baseurl }}&quot;</span><span class="nt">&gt;</span>{{ post.title }}<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>{{ post.summary }}<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/li&gt;</span>
    {% endfor %}
  <span class="nt">&lt;/ul&gt;</span>

<span class="nt">&lt;/div&gt;</span></code></pre></div> <p>Most of the work here is done in javascript, let’s create two javascript files in the folder <code>js</code> folder. We create <code>search.js</code> for the search page and <code>home.js</code> for all other pages. To attach these javascript files to the corresponding files, add the following to the end of <code>_includes/footer.html</code>,</p> <div class="highlight"><pre><code class="language-html" data-lang="html">{% if page.type == &#39;search&#39; %}
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/js/search.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
{% else %}
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/js/home.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
{% endif %}</code></pre></div> <p>In <code>home.js</code>, we need to handle the search form submit. Once form is submitted with something in the searchbox, we can send then to <code>/search#query</code>, where <code>query</code> is the searched query. So, <code>home.js</code> will be as below. So if the webpage is <code>botleg.com</code> and <code>query</code> is <code>test</code>, the resulting page will be <code>botleg.com/search/#test</code></p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;searchform&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">search</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;searchbox&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;/search/#&#39;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;searchbox&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nx">search</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onsubmit&#39;</span><span class="p">,</span> <span class="nx">search</span><span class="p">);</span>
<span class="p">}</span></code></pre></div> <p>In <code>search.js</code>, we can read the search query with,</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></code></pre></div> <p>We will send a <code>GET</code> request to the <code>/search/:q</code> with AJAX, where <code>:q</code> is replaced by the search query and its response contains the search results. These are then injected into the web page. You can search for another query and a new request will be sent. Complete code for <code>search.js</code> is given below.</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;searchform&#39;</span><span class="p">),</span>
    <span class="nx">box</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;searchbox&#39;</span><span class="p">),</span>
    <span class="nx">span</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">),</span>
    <span class="nx">list</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;post-list&#39;</span><span class="p">),</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;span class=&quot;text&quot;&gt;Sorry, No results.&lt;/span&gt;&#39;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&lt;a class=&quot;post-link&quot; href=&quot;/posts/&#39;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/a&gt;&lt;p&gt;&#39;</span> <span class="o">+</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">summary</span> <span class="o">+</span> <span class="s1">&#39;&lt;/p&gt;&lt;/li&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">search</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;span class=&quot;text&quot;&gt;Loading results...&lt;/span&gt;&#39;</span><span class="p">;</span>

  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="s1">&#39;http://elastic.api.botleg.com/search/&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">));</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">searchFrm</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="nx">box</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">);</span>
    <span class="nx">search</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">box</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<span class="nx">search</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nx">searchFrm</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">form</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onsubmit&#39;</span><span class="p">,</span> <span class="nx">searchFrm</span><span class="p">);</span>
<span class="p">}</span></code></pre></div> <p>That’s all there is. Once you push your changes to GitHub, the posts will be indexed by Elasticsearch and these can then be searched. The code for the Jekyll Frontend can be found <a href="https://github.com/botleg/elasticsearch-jekyll/tree/gh-pages">here</a>.</p> <h2 id="tldr">TL;DR</h2> <p>The working demo for this article is hosted <a href="http://elastic.jekyll.botleg.com/">here</a> and the code for this can be found <a href="https://github.com/botleg/elasticsearch-jekyll/">here</a>. We can create an Elasticsearch endpoint using <a href="https://appbase.io/">appbase.io</a>. Then we need a web API backend to handle Webhooks. From Webhooks, we can get the information about file changes in Jekyll repository which can then used to index these posts with Elasticsearch. Once these are indexed, we can use AJAX requests to Elasticsearch and show search results by injecting it into webpage. And that’s one way to implement Elasticsearch in a Jekyll Blog.</p> <p class="post-meta">Tags: elasticsearch, appbase.io, lucene, github-pages, node.js, koa, openshift, webhooks, javascript, markdown, ajax, popular, and jekyll </p> </article> <article class="post-comments" id="comments-box"> <h1 class="page-title">Comments</h1> <form id="new-comment"> <input type="text" id="nameField" placeholder="Enter your name" required><br/> <textarea id="textField" placeholder="Your comments please." required></textarea><br/> <button type="submit" id="commentBtn">Post Comment</button> </form> <div id="comments"></div> </article> </section> <aside> <div class="aside" id="cat-list"> <h1 class="page-heading">Categories</h1> <a href="/categories/about">About</a><br/> <a href="/categories/jekyll">Jekyll</a><br/> <a href="/categories/cloud">Cloud</a><br/> <a href="/categories/node.js">Node.js</a><br/> </div> <div class="aside"> <h1 class="page-heading">Related Stories</h1> <a href=/stories/hello-world>hello world :)</a><br/><a href=/stories/build-and-deploy-to-openshift-with-travisci-and-wercker>Build and Deploy to OpenShift with TravisCI and Wercker</a><br/><a href=/stories/line-numbers-in-jekyll-code-blocks>Line numbers in Jekyll code blocks</a><br/><a href=/stories/using-your-sessions-with-socketio>Using your sessions with Socket.IO</a><br/> </div> <p class="rss-subscribe">subscribe <a href="/feed">via RSS</a></p> <a href="#">Scroll to Top</a> </aside> </div> </div> </div> <footer class="site-footer"> <div class="footer-wrap"> <h2 class="footer-heading">Botleg</h2> <div class="footer-col-wrapper"> <div class="footer-col footer-col-1"> <ul class="contact-list"> <li>By Hanzel Jesheen</li> <li><a href="mailto:blog@botleg.com">blog@botleg.com</a></li> <li> <a href="https://github.com/botleg"><span class="username">botleg </span> <span class="icon"> <svg viewBox="0 0 16 16" width="16px" height="16px"> <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/> </svg> </span> </a> </li> </ul> </div> <div class="footer-col footer-col-2"> <ul class="social-media-list"> <li><a href="https://github.com/hanzeljesheen"><span class="username">github</span></a></li> <li><a href="https://bitbucket.org/hanzel"><span class="username">bitbucket</span></a></li> </ul> </div> <div class="footer-col footer-col-3"> <p>Hi, botleg is a blog where you can find tutorials and techniques in web development, big data analysis, databases, cloud computing and anything related to technology.</p> </div> </div> </div> </footer> <script>var cb=function(){var a=document.createElement("link");a.rel="stylesheet";a.href="/assets/main.css?v105";var b=document.getElementsByTagName("head")[0];b.parentNode.insertBefore(a,b);};var raf=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;if(raf){raf(cb);}else{window.addEventListener("load",cb);}</script> <script src="/assets/js/post.js"></script> </body> </html>